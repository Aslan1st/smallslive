{% extends "home_new.html" %}
{% load static from staticfiles %}
{% load addurlparameter %}

{% block schedule_nav_active %}active{% endblock %}

{% block title %}Calendar/Archive{% endblock %}

{% block home_content %}
<main>
  <div>
    <section class="event-stripe">
      <div class="section-title">
        <div class="title1">
          Tonight's Shows <span class="date-separator">/</span>
        </div>
        <div class="header-sub title2">{% now "l F j, o" %}</div>
      </div>
      <main>
        {% include 'events/event_row.html' with events=events_today show_time='True' hidde_event_date='True' show_event_venue='True' %}
      </main>
    </section>
  <div class="flex flex-row content-space-between items-flex-end">
    <div class="section-title calendar-section">
      <div class="title1">Upcoming shows</div>
    </div>
    <div class="select-container flex-row">
      <div class="white-border-select" style="width:150px;">
        <select id="venueSelect">
          <option value=""{% if not venue_selected %} selected{% endif %}>All</option>
          {% for venue in venues %}
            <option value="{{ venue.id }}"{% if venue_selected == venue.id %} selected{% endif %}>{{ venue.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="date-picker"
           id="schedule__date-picker">
        <input type="text" placeholder="Select a month" readonly>
        <i class="fa fa-caret-down"></i>
      </div>
    </div>
  </div>
    <main class="schedule-dates-conatainer">
      <div class="flex flex-row content-space-around items-flex-start wrap">
        <a href="{{ prev_url }}">
          <i class="fa fa-angle-left big-icon"></i>
        </a>
        <div class="flex flex-row flex-grow content-space-around items-flex-start wrap ">
          {% include 'events/calendar_week.html' with dates=dates %}
        </div>
        <a href="{{ next_url }}"><i class="fa fa-angle-right big-icon"></i></a>
      </div>
    </main>
  </div>
</main>
{% endblock home_content %}

{% block extra_js %}
  <!-- Bootstrap datepicker JavaScript -->
  <script src="{% static 'js/bootstrap-datepicker.js' %}"></script>
  <script>
    $(document).ready(function () {
      var initialDate = new Date({{ year}}, {{ month }}, {% if day %}{{ day }}{% else %}1{% endif %});
      console.log('Initial date', initialDate);

      var $datePicker = $('#schedule__date-picker input');
      $datePicker.datepicker({
        format: 'MM // yyyy',
        orientation: "top auto",
        autoclose: true,
        startDate: new Date()
      });

      $datePicker.datepicker("setDate", initialDate);

      $datePicker.on('changeDate', function(newDate) {
        var month = newDate.date.getMonth();
        var year = newDate.date.getFullYear();
        var day = newDate.date.getDate();

        var selectedDay = new Date(year, month, day + 1);

        var weekDiff = calculateWeeksBetween(selectedDay, new Date());
        console.log('Week diff:', weekDiff);

        if (weekDiff === 0) {
          window.location = "{% addurlparameter 'week' None %}";
        } else {
          window.location = "{% addurlparameter 'week' "1" %}".replace(
            'week=1', 'week='+weekDiff
          );
        }
      });

      {#TODO Select using url param#}
      var venueSelect = $('#venueSelect');
      venueSelect.on('change', function () {
        var selected = venueSelect.val();
        var newLocation;
        if (selected) {
          newLocation = "{% addurlparameter 'venue' "-1" %}".replace('venue=-1', 'venue='+selected);
        } else {
          newLocation = "{% addurlparameter 'venue' None %}";
        }
        window.location = newLocation;
      });
    });
  </script>
{% endblock extra_js %}
