{% load static from staticfiles %}
{% load thumbor_tags %}
{% load common_tags %}
{% load i18n %}

<section class=" new-calendar search-tab-content {% if archived %}archived{% else %}upcoming{% endif %} {{ archived|yesno:',shows-calendar' }} "
         data-toggle-tab="{% if archived %}archived{% else %}upcoming{% endif %}-shows"
         data-toggle-tab-group="search-results"{% if placeholder %} style="display:none;"{% endif %}>
  <div id="new-calendar">
  {% if archived or upcoming %}
   <div class="musicians-results flex-row">
      <div class="section-title home" style="width: 950px;     background-size: 900px 5px;">
          <div class="title1">
              Upcoming Shows <span class="date-separator">/</span>
          </div>
          <div class="header-sub title1">{{ upcoming_dates.first|date:'D M d Y' }} - {{ upcoming_dates.last|date:'D M d Y' }}</div>
      </div>
      <div class="white-border-select club-filter-select">
        <select id="calendar-club-filter">
            <option value="all">All</option>
          {% for venue in venues %}
            <option value="{{venue.pk}}">{{venue.name}}</option>
          {% endfor %}
        </select>
      </div>
  </div> 
  {% endif %}
   <div class="flex-row upcoming-schedule calendar-hiding-4">
    <div class="flex-row upcoming-datepicker">
      <div  class="datepicker-container noclick" style="display:block;     top: 0 !important;">
          <div class="custom-date-picker" id="calendar-date-picker">
          </div>
      </div>
    </div>
    {% include 'search/upcoming_calendar_dates.html' with day_list=day_list %}
    <div id="load-more-calendar" data-starting-date="none" data-venue="all" class="white-border-button">Load more</div>
  </div>
  </div>
</section>

<script src="{% static 'js/viewport-lenght-for-ios.js' %}"></script>
<script>
today = new Date()
todayStr =   today.getFullYear() + "-" + (today.getMonth() + 1) + "-" + today.getDate()
$("#load-more-calendar").data("starting-date", todayStr)
 $(window).on('load', function () {
    $("#upcoming-datepicker").click()

  })
  function getCalendarAjax(calendarDate, days, filtered, venue="all"){
    $.ajax({
    url: '/search/upcoming-ajax/',
    data: {'starting_date': calendarDate, 'days':days, 'venue':venue},
    dataType: "json",
    success: function (data) {
       var hidden = getHiddenCount();
        function getNewHidder(hidden){
          if(hidden==1)
          return 4
          else
          return hidden-1
        }
      if(filtered){
        $(".flex-row.upcoming-schedule").removeClass("calendar-hiding-"+hidden)
        $(".flex-row.upcoming-schedule").addClass("calendar-hiding-4")

        $(".flex-column.day-list").remove()
        $(".upcoming-schedule").find(".flex-row.upcoming-datepicker").last().after(data.template)
      }else{
        $(".flex-row.upcoming-schedule").removeClass("calendar-hiding-"+hidden)
        $(".flex-row.upcoming-schedule").addClass("calendar-hiding-"+getNewHidder(hidden))
        $(".upcoming-schedule").find(".flex-column.day-list").last().after(data.template)
      }
      $("#load-more-calendar").data("starting-date", data.new_date);

    },
    error: function(err){
      console.log(err)
    }
    });

  }
  $("#load-more-calendar").on("click", function(){

    getCalendarAjax($(this).data("starting-date"), 15, false,$("#load-more-calendar").data("venue"))

  })

  $("#calendar-club-filter").change(function () {
    $("#load-more-calendar").data("venue",$(this).find("option:selected").val())
    $("#load-more-calendar").data("starting-date",todayStr)
    getCalendarAjax($("#load-more-calendar").data("starting-date"), 12, true, $(this).find("option:selected").val())
  });

  function getHiddenCount() {
  var numberStr = $($(".flex-row.upcoming-schedule")[0]).attr('class').split('calendar-hiding-')[1].split('')[0];
  return parseInt(numberStr);
  }
</script>
  