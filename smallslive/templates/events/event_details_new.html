{% extends "home_new.html" %}
{% load static from staticfiles %}
{% load thumbor_tags %}
{% load thumbnail %}
{% load currency_filters %}
{% load i18n %}
{% load purchase_info_tags %}
{% load basket_tags %}
{% load crispy_forms_tags %}

{% block schedule_nav_active %}active{% endblock %}

{% block title %}{{ event.title }}{% endblock %}

{% block extra_head %}
  <meta property="og:url" content="{{ request.build_absolute_uri }}"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="SmallsLIVE"/>
  <meta property="og:title" content="{{ event.full_title }}"/>
  <meta property="og:description"
        content="{{ event.listing_date|date:"l, F j, Y" }} {{ event.start|date:"g:i A" }} - {{ event.end|date:"g:i A" }}"/>
  {% if event.photo %}
    <meta property="og:image" content="https:{% thumbor_url event.get_photo_url|urlencode height=315 width=600 smart=True %}"/>
    <meta itemprop="image" content="https:{% thumbor_url event.get_photo_url|urlencode height=315 width=600 smart=True %}">
  {% endif %}
  <meta property="fb:app_id" content="{{ facebook_app_id }}"/>
  <meta itemprop="name" content="{{ event.full_title }}">
  <meta itemprop="description"
        content="{{ event.listing_date|date:"l, F j, Y" }} {{ event.start|date:"g:i A" }} - {{ event.end|date:"g:i A" }}">
{% endblock %}

{% block home_content %}
  {% include 'events/tickets_dialog.html' %}

  <div class="event-page-container">
    <div class="flex-column flex event-container">
    {% if event.is_live %}
       <div class="player-container">
         <div style="padding-bottom:56.25%; position:relative; display:block; width: 800px; height: 450px">
           <iframe id="UstreamIframe"
                   width="100%" height="100%"
                   src="{{ event.get_live_stream }}"
                   frameborder="0"
                   style="position:absolute; top:0; left: 0" allowfullscreen
                   webkitallowfullscreen></iframe>
         </div>
       </div>
    {% elif event.is_future %}
      <div class="event-video-placeholder flex-column content-space-between">
        <span class="event-video-placeholder-picture" style="{% if event.photo %}
           {% include 'partials/thumbored_picture_style.html' with photo_url=event.get_photo_url crop_box=event.photo_crop_box %}
         {% else %}
           {% include 'partials/thumbored_picture_style.html' %}
         {% endif %}
       "></span>
        <div class="player-info">
          {% if event.is_live %}
            <div class="live-now text2">Live now</div>
          {% endif %}
          <div class="event-overlay">
            <div class="event-overlay-title">{{ event.title }}</div>
            <div class="event-overlay-artists">
              {% for gig_info in event.artists_gig_info.all %}
                <div class="title5">
                  {{ gig_info.artist.full_name }} <span class="accent-color">/</span> {{ gig_info.role.name }}
                </div>
              {% endfor %}
            </div>
            <div class="event-overlay-venue">
                <div class="title5">{{ event.date|date:'m/d/Y' }}</div>
                {% if event.sets.count %}
                    <div class="title5">
                      Sets at
                      {% for set in event.sets.all %}
                        <span class="event-overlay-venue-set">
                          {{ set.start|time:"g:iA"}}
                        </span>
                      {% endfor %}
                    </div>
                {% endif %}
              <div class="title5 accent-color">LIVE AT {{event.venue.name }}</div>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      {% if event.published_videos %}
        <div id="videoContainer" class="player-container {% if user.can_watch_video %}allowed{% else %}forbidden{% endif %}">
          <div id="player-video"></div>
          <div class="player-info" id="playerTextOverlay">
            <div class="event-overlay">
              <div class="event-overlay-logo">
                  <img src="{% static 'logo.svg' %}" alt="Smalls"
                                        class="img-circle" width="40" height="40"/>
              </div>
              <div class="event-overlay-title">{{ event.title }}</div>
              <div class="event-overlay-artists">
                {% for gig_info in event.artists_gig_info.all %}
                  <div class="title5">
                    {{ gig_info.artist.full_name }} <span class="accent-color">/</span> {{ gig_info.role.name }}
                  </div>
                {% endfor %}
              </div>

            </div>
          </div>

        </div>
      {% endif %}
      {% if event.published_audio %}
        <div id="audioContainer" class="player-container" style="display: none;">
          <div id="player-audio" class="{% if user.can_watch_video %}allowed{% else %}forbidden{% endif %}"></div>
          <div class="player-info" id="playerAudioTextOverlay">
            <div class="accent-color text2">{{ event.date|date:'m/d/Y' }}</div>
            <div class="event-overlay-title">{{ event.title }}</div>
          </div>
        </div>
      {% endif %}
    {% endif %}

    <div class="event-video-info content-space-between">
      <div class=" flex-column">
        <div class="event-set-info">
          <div class="event-title title1">{{ event.title }}</div>
            <div class="accent-color text7">
              {{ event.date|date:'m/d/Y' }}</div>
        </div>
        <div class="event-overlay-venue">
          {% if event.sets.count and event.is_future %}
            <div class="title5">
              Sets at
              {% for set in event.sets.all %}
                <span class="event-overlay-venue-set">
                  {{ set.start|time:"g:iA"}}
                </span>
              {% endfor %}
            </div>
            <div class="title5 accent-color">LIVE AT {{event.venue.name }}</div>
          {% endif %}
        </div>

      </div>
      <div class="flex-colum buttons-container">
        {% if event.is_past %}
        {% for set in event.sets.all %}
          <button class="set-select-button white-border-button {{ forloop.counter0|yesno:',active' }}"
                  data-comments-page="{% url 'event_comments' pk=event.id slug=event.slug %}?set={{ forloop.counter0 }}"
                  data-playlist-index="{{ forloop.counter0 }}">Set {{ forloop.counter }}
          </button>
        {% endfor %}
        {% endif %}
        {% if event.is_past and event.published_audio %}
            <button class="white-border-button audio togglePlayer" style="display: inline;">
              Audio only player
            </button>
        {% endif %}
        {% if event.is_past and event.published_videos %}

          <button class="white-border-button video togglePlayer"
                  style="display: none;">
              Video player
          </button>
        {% endif %}
        <div class="event-player-buttons text-right">
          {% if user.is_admin or user.is_staff %}
            <a href="{% url 'event_edit' pk=event.id slug=event.slug %}" style="display: inline-block; margin-right: 5px;">
                <button class="white-border-button">Edit</button>
            </a>
          {% endif %}
          {% if not event.is_live and event.is_past %}
          <button id="btn-donate" class="white-border-button" style="display: inline;">Donate</button>
          {% endif %}
          {% if not event.is_live and event.is_future %}
          <button class="white-border-button" onclick="showTickets()" style="display: inline;">Tickets</button>
          {% endif %}
        </div>
      </div>
    </div>
            <div class="event-band">
          {% for gig_info in event.artists_gig_info.all %}
            <div>
              <a href="{{ gig_info.artist.get_absolute_url }}" class="artist-link">
                {{ gig_info.artist.full_name }} / {{ gig_info.role.name }}</a>
            </div>
          {% endfor %}
        </div>

    <div class="flex-row event-set-selector"></div>
    {% if event.published_audio or event.published_video %}
        <div class="comments-container" data-subpage-url="{% url 'event_comments' pk=event.id slug=event.slug %}?set=0" data-subpage-name="comments"></div>
    {% endif %}
    </div>
    <div class="flex-column event-side">
      {% if streaming_tonight_videos %}
        <div class="event-related-videos">
          <div class="section-title section-flex">
            <div class="title1">Streaming Tonight <span class="date-separator">/</span></div>
            <div class="header-sub title2">{% now "m/d/y" %}</div>
          </div>
          <div>
              <div>
              {% for related in streaming_tonight_videos %}
                <div class="flex-row related-video {% if related == event %}selected{% endif %}">
                  {% include 'events/event_card.html' with event=related mini=True show_time=True %}
                  <div class="related-info flex-column content-centered">
                    <div class="flex-column">
                      <div class="text1 related-title">{{ related.title }}</div>
                      <div class="text1 text-grey">
                        {{ related.date|date:'m/d/Y' }}</div>
                      <div class="accent-color text-uppercase">
                          <strong>{{ related.venue.name }}</strong></div>
                    </div>
                  </div>
                </div>
              {% endfor %}
              </div>
          </div>
        </div>
      {% endif %}
      <div class="event-related-videos">
        <div class="section-title section-flex">
          <div class="title1">Related videos</div>
        </div>
        <div>
            <div>
              {% for related in related_videos%}
                <div class="flex-row related-video">
                  {% include 'events/event_card.html' with event=related mini=True %}
                  <div class="related-info flex-column content-centered">
                    <div class="flex-column">
                      <div class="text1 related-title">{{ related.title }}</div>
                      <div class="text1 text-grey">{{ related.date|date:'m/d/Y' }}</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'js/moment.min.js' %}"></script>
  <script>
  var showRegister = function() {
    $('#becomeMemberDialog').modal('show');
  };

  var showTickets = function () {
    $('#ticketsDialog').modal('show');
  };

  var goToSupporter = function() {
    window.location = '{% url 'become_supporter' %}';
  };
  </script>
  <script src="https://jwpsrv.com/library/w1FDmNWFEeS9qhJtO5t17w.js"></script>
  <script src="{% static 'js/jquery.form.js' %}"></script>
  <script src="{% static 'js/subpages.js' %}"></script>

  <script>
      var subpages = window.subpages;
      subpages.register();
      subpages.loadAll();

      $(document).on('click', '[data-playlist-index]', function (ev) {
          var subpage = subpages.get('comments');
          if (subpage) {
            subpage.setUrl($(this).data('comments-page'));
          }
      });

  </script>


  {% if event.sets.count %}

      <script>
        var playsCountSent = [];
        var activeTracker = null;
        function updateViewCount(player) {
          var id = player.getPlaylistItem(player.getPlaylistIndex()).mediaid;
          if (playsCountSent.indexOf(id) === -1) {
            playsCountSent.push(id);
            $.post('/multimedia/update_media_viewcount/', {
              recording_id: id,
              csrfmiddlewaretoken: '{{ csrf_token }}'

            });
          }
        }

        function updateSetText(textElement, currentItem, totalSets) {
          var setText = "Set " + currentItem + "/" + totalSets;
          $(textElement).text(setText);
        }

        {% if count_metrics %}
            var metricsSignedData = {{ metrics_signed_data|safe }};

            var pingMetricsServer = function(mediaId) {
                var data = {};
                data.signed_data = metricsSignedData[mediaId];
                data.csrfmiddlewaretoken = '{{ csrf_token }}';
                $.ajax({
                    url: "{{ metrics_server_url }}/metric/",
                    method: 'POST',
                    headers: {
                        "Authorization": "Token {{ user_token }}"
                    },
                    data: data,
                    xhrFields: {
                        withCredentials: true
                    }
                })
            };

            function setUpTimerForMedia(mediaId) {
                pingMetricsServer(mediaId);
                if (!activeTracker) {
                    activeTracker = window.setInterval(function () {
                                pingMetricsServer(mediaId);
                            }, {{ metrics_ping_interval }} * 1000
                    )
                }
            }
        {% endif %}

        {% if event.published_audio %}
          audioPlayer = jwplayer("player-audio").setup({
            primary: 'html5',
            playlist: [
              {% for audio in event.published_audio %}
                {
                  sources: [{
                    file: "{{ audio.media_file.get_file_url|safe }}",
                    type: "mp3"
                  }],
                  image: {% include 'partials/thumbor_url.html' with photo_url=event.get_photo_url crop_box=event.photo_crop_box %},
                  mediaid: {{ audio.id }}
                }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ],
            width: "100%",
            height: "27.5vw"  // If you change this please be kind and change the corresponding css.
          });
          audioPlayer.on('play', function () {
            var $videoContainer = $('#videoContainer');
            if ($videoContainer.hasClass('forbidden')) {
              videoPlayer.stop();
              $('#become-a-supporter-dialog').modal('show');
            } else {
              {% if user.can_watch_video and event.published_videos %}videoPlayer.pause(true);{% endif %}
              updateViewCount(this);
              {% if count_metrics %}
              if (! activeTracker) {
                setUpTimerForMedia(this.getPlaylistItem(this.getPlaylistIndex()).mediaid);
              }
              {% endif %}
            }
          });

          {% if count_metrics %}
          audioPlayer.on('pause', function() {
              window.clearInterval(activeTracker);
              activeTracker = null;
          });
          {% endif %}

          audioPlayer.on('ready', function () {
            var playlist = audioPlayer.getPlaylist();
            var playlistItems = "";
            $.each(playlist, function (index, item) {
              playlistItems += '<button class="';
              if (index === 0) {
                playlistItems += ' active';
              }
              playlistItems += '" data-comments-page="' + '{% url 'event_comments' pk=event.id slug=event.slug %}?set=' + index;
              playlistItems += '" data-playlist-index="' + index + '">Set ' + (index + 1) + '</button>';
            });
            $("#audio-sets-list").html(playlistItems);
          });

          $('#audio-sets-list').on('click', 'button', function () {
            var currentIndex = audioPlayer.getPlaylistIndex();
            var selectedIndex = $(this).data('playlist-index');
            audioPlayer.playlistItem(selectedIndex);
            $('#set-number').html(selectedIndex + 1);
            $(this).toggleClass('active');
            $('#audio-sets-list button[data-playlist-index=' + currentIndex + ']').toggleClass('active');
          });
        {% endif %}

        {% if event.published_videos %}
            videoPlayer = jwplayer("player-video").setup({
                primary: 'html5',
                playlist: [
                    {% for video in event.published_videos %}{% if video.media_file.sd_video_file %}
                    {
                        sources: [{
                            file: "{{ video.media_file.get_sd_video_url|safe }}",
                            type: "mp4"
                        }],
                        mediaid: {{ video.id }},
                        image: {% include 'partials/thumbor_url.html' with photo_url=event.get_photo_url crop_box=event.photo_crop_box %}
                    }{% if not forloop.last %},{% endif %}
                    {% endif %}{% endfor %}
                ],
                skin: "https:{% static "jwplayer-skin/smalls.xml" %}",
                width: "100%",
                aspectratio: "16:9",
            });
            videoPlayer.on('play', function () {
                var $videoContainer = $('#videoContainer');
                if ($videoContainer.hasClass('forbidden')) {
                  videoPlayer.stop();
                  $('#become-a-supporter-dialog').modal('show');
                } else {
                  var $overlay = $('#playerTextOverlay');
                  $overlay.addClass('hidden');
                  $overlay.removeClass('paused');
                  audioPlayer.pause(true);
                  updateViewCount(this);
                  {% if count_metrics %}setUpTimerForMedia(this.getPlaylistItem(this.getPlaylistIndex()).mediaid);{% endif %}
                  $overlay.css('opacity', 0);
                }

            });
              videoPlayer.on('pause', function() {
                var $overlay = $('#playerTextOverlay');
                $overlay.removeClass('hidden');
                $overlay.addClass('paused');
                {% if count_metrics %}
                  window.clearInterval(activeTracker);
                  activeTracker = null;
                {% endif %}
                $overlay.css('opacity', 1);
              });
            $('.set-select-button').on('click', function () {
                var selectedIndex = $(this).data('playlist-index');
                videoPlayer.playlistItem(selectedIndex);
                $('#set-number').html(selectedIndex + 1);
                $('.set-select-button').removeClass('active');
                $(this).toggleClass('active');
            });
        {% endif %}

        {% if event.is_live or event.is_today %}
          {% if next_streaming %}
              console.log('Setting Timer')
            var changeTime = moment("{{ next_streaming.start.isoformat }}");
            var waitTime = changeTime.diff(moment(), 'miliseconds');
            var intervalId = setInterval(function () {
                clearInterval(intervalId);
                window.location = "{{ next_streaming.event_url }}";
            }, waitTime);
          {% endif %}
        {% endif %}


        $(document).ready(function () {

          $('.togglePlayer').click(function () {

            $this = $(this);
            if ($this.hasClass('video')) {
              $this.parent().find('.audio').css('display', 'inline');
              $this.hide();
              $('#videoContainer').show();
              $('#audioContainer').hide()
            } else {
              $this.parent().find('.video').css('display', 'inline');
              $this.hide();
              $('#audioContainer').show();
              $('#videoContainer').hide()
            }

            // Update comments page.
            var url = $('button[data-playlist-index]:visible.active').data('comments-page');
            var comments = subpages.get('comments');
            if (comments) {
              comments.setUrl(url);
            }
          });

          $('#btn-donate').click(function () {
            window.location = "{{ donate_url }}";
          });

        });

      </script>
  {% endif %}
    {% with album=event.products.first %}
        {% if album and album.tracks %}
            <script>
                var tracksPlayer = jwplayer("player-tracks").setup({
                    primary: 'html5',
                    playlist: [
                        {% for track in album.tracks.all %}
                            {% if track.preview %}
                                {
                                    sources: [{
                                        file: "{{ track.get_track_preview_url|safe }}",
                                        type: "mp3"
                                    }],
                                    mediaid: {{ track.id }}
                                }{% if not forloop.last %},{% endif %}
                            {% endif %}
                        {% endfor %}
                    ],
                    skin: "{% static "jwplayer-skin/smalls.xml" %}",
                    width: "100%",
                    height: 0
                });
                $(".playback-control").on('click', function (e) {
                    e.preventDefault();
                    if (tracksPlayer.getPlaylistIndex() == $(this).data('playlist-id')) {
                        tracksPlayer.pause();
                    } else {
                        tracksPlayer.playlistItem($(this).data('playlist-id'));
                        $('.playback-control i').removeClass('fa-pause').addClass('fa-play');
                    }
                    $(this).find('i').toggleClass('fa-play').toggleClass('fa-pause');
                });
            </script>
        {% endif %}
    {% endwith %}

{% endblock %}
