{% extends "home_new.html" %}
{% load static from staticfiles %}
{% load thumbor_tags %}
{% load thumbnail %}
{% load currency_filters %}
{% load i18n %}
{% load purchase_info_tags %}
{% load basket_tags %}
{% load crispy_forms_tags %}

{% block schedule_nav_active %}active{% endblock %}

{% block title %}{{ event.title }}{% endblock %}

{% block extra_head %}
  <meta property="og:url" content="{{ request.build_absolute_uri }}"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="SmallsLIVE"/>
  <meta property="og:title" content="{{ event.full_title }}"/>
  <meta property="og:description"
        content="{{ event.listing_date|date:"l, F j, Y" }} {{ event.start|date:"g:i A" }} - {{ event.end|date:"g:i A" }}"/>
  {% if event.photo %}
    <meta property="og:image" content="https:{% thumbor_url event.photo.url|urlencode height=315 width=600 smart=True %}"/>
    <meta itemprop="image" content="https:{% thumbor_url event.photo.url|urlencode height=315 width=600 smart=True %}">
  {% endif %}
  <meta property="fb:app_id" content="{{ facebook_app_id }}"/>
  <meta itemprop="name" content="{{ event.full_title }}">
  <meta itemprop="description"
        content="{{ event.listing_date|date:"l, F j, Y" }} {{ event.start|date:"g:i A" }} - {{ event.end|date:"g:i A" }}">
{% endblock %}

{% block home_content %}
  {% include 'events/tickets_dialog.html' %}

  <div class="event-page-container">
    <div class="flex-column flex event-container">
    {% if user.is_authenticated %}
      {% if event.is_live %}
         <div class="player-container">
           <div style="padding-bottom:56.25%; position:relative; display:block; width: 800px; height: 450px">
             <iframe id="UstreamIframe"
                     width="100%" height="100%"
                     src="https://www.ustream.tv/embed/23240575?html5ui"
                     frameborder="0"
                     style="position:absolute; top:0; left: 0" allowfullscreen
                     webkitallowfullscreen></iframe>
           </div>
         </div>
      {% elif event.is_future %}
        <div class="event-video-placeholder flex-column content-space-between">
          <span class="event-video-placeholder-picture" style="{% if event.photo %}
             {% include 'partials/thumbored_picture_style.html' with photo_url=event.photo.url crop_box=event.photo_crop_box %}
           {% else %}
             {% include 'partials/thumbored_picture_style.html' %}
           {% endif %}
         "></span>
          <div class="player-info flex-column content-space-between">
            <div>
              <div class="accent-color text2">{{ event.date|date:'m/d/Y' }}</div>
              <div class="title1">{{ event.title }}</div>
            </div>
            <div>
              <div class="accent-color text2">{{ event.venue }}</div>
              <div class="text4">Sets at {{ event.get_set_hours_display }}</div>
            </div>
          </div>
        </div>
      {% else %}
        {% if user.can_watch_video %}
          {% if event.published_videos %}
            <div id="videoContainer" class="player-container">
              <div id="player-video"></div>
              <div class="player-info" id="playerTextOveraly">
                {% if event.is_live %}
                  <div class="live-now text2">Live now</div>
                {% endif %}
                <div class="event-overlay">
                  <div class="event-overlay-title">{{ event.title }}</div>
                  <div class="event-overlay-artists">
                    {% for gig_info in event.artists_gig_info.all %}
                      <div class="title5"> 
                        {{ gig_info.artist.full_name }} <span class="accent-color">/</span> {{ gig_info.role.name }}
                      </div>
                    {% endfor %}
                  </div>
                  <div class="event-overlay-venue">
                      <div class="title5">{{ event.date|date:'m/d/Y' }}</div>
                      {% if event.sets.count and event.is_live %}
                          <div class="title5"> 
                            Sets at 
                            {% for set in event.sets.all %}
                              <span class="event-overlay-venue-set">
                                {{ set.start|time:"g:iA"}}
                              </span>
                            {% endfor %}
                          </div>
                      {% endif %}
                    <div class="title5 accent-color">LIVE AT {{event.venue.name }}</div>
                  </div>
                </div>
              </div>
              <div class="accent-color text2">
                {{ event.date|date:'m/d/Y' }}
              </div>
            </div>
          {% endif %}
        {% else %}
          <div class="event-video-placeholder flex-column content-space-between">
              <span class="event-video-placeholder-picture" style="{% if event.photo %}
                 {% include 'partials/thumbored_picture_style.html' with photo_url=event.photo.url crop_box=event.photo_crop_box %}
               {% else %}
                 {% include 'partials/thumbored_picture_style.html' %}
               {% endif %}
             "></span>
              <div class="overlay-info flex-column items-center content-space-around">
                  <p class="title2 accent-color">Archive Access</p>
                  <p class="title3">Become a supporter</p>
                  <p class="text7">Access archive videos by becoming a Supporting Member. Your supporting pledge goes
                      directly to your favorite artists and helps make SmallsLIVE possible through our SmallsLIVE
                      Revenue Share. Supporting Members have unlimited access to our archive of nearly every concert
                      performed at Smalls & Mezzrow with new concerts added weekly. By listening to your favorite
                      artists in the archive you are getting them paid.</p>
                  <button class="white-border-button" onclick="goToSupporter()">Become a Supporter</button>
              </div>
          </div>
        {% endif %}
        {% if event.published_audio %}
          <div id="audioContainer" class="player-container" style="display:none;">
            <div id="player-audio"></div>
            <div class="player-info" id="playerTextOveraly">
              <div class="accent-color text2">{{ event.date|date:'m/d/Y' }}</div>
              <div class="event-overlay-title">{{ event.title }}</div>
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% else %}
        <div class="event-video-placeholder flex-column content-space-between">
          <span class="event-video-placeholder-picture" style="{% if event.photo %}
             {% include 'partials/thumbored_picture_style.html' with photo_url=event.photo.url crop_box=event.photo_crop_box %}
           {% else %}
             {% include 'partials/thumbored_picture_style.html' %}
           {% endif %}
         "></span>
          <div class="overlay-info flex-column items-center content-space-around">
            <p class="title2 accent-color">Live Stream Access</p>
            <p class="title3">Sign up</p>
            <p class="text7">Our live stream has expanded our 60 seat clubs into a worldwide community of jazz fans and supporters. Sign up for free to watch our live streams each night.</p>
            <button class="white-border-button register-button" onclick="showRegister()">Become a Member</button>
          </div>
        </div>
    {% endif %}
    <div class="event-video-info flex-row content-space-between">
      <div class=" flex-column">
        <div class="event-set-info">
          <div class="event-title title1">{{ event.title }}</div>
          {% if event.is_past %}
            <div class="accent-color text2">Set <span id="set-number">1</span></div>
            <div class="accent-color text2">
              {{ event.date|date:'m/d/Y' }}</div>
          {% endif %}
        </div>
        <div class="flex-row event-band">
          {% for performers_column in performers %}
            <div class="flex-column">
              {% for gig_info in performers_column %}
                <div class="event-info-artist">
                  <a href="{{ gig_info.artist.get_absolute_url }}"
                     class="artist-link">
                    {{ gig_info.artist.full_name }} / {{ gig_info.role }}
                  </a>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
        <div id="video-set-buttons">
          <div class="button-row set-buttons" id="video-sets-list">
          </div>
        </div>
        <div id="audio-set-buttons" style="display: none;">
          <div class="button-row set-buttons" id="audio-sets-list">
          </div>
        </div>
      </div>
      <div class="event-player-buttons flex-column items-flex-stretch">
          {% if event.is_past and user.can_listen_to_audio%}
              {% if event.published_videos %}
                  <button class="white-border-button" id="togglePlayerAudio">
                      Audio only player
                  </button>
              {% endif %}

              <button class="white-border-button" id="togglePlayerVideo"
                      style="display: none">
                  {% if event.published_videos %}
                      Video player
                  {% else %}
                      Audio only
                  {% endif %}
              </button>
          {% endif %}
          {% if not event.is_live and event.is_past %}
              <button disabled class="white-border-button">Download for $9.99</button>
          {% elif not event.is_live and event.is_future %}
              <button class="white-border-button" onclick="showTickets()">Tickets</button>
          {% endif %}
          {% if user.is_admin or user.is_staff %}
              <a href="{% url 'event_edit' pk=event.id slug=event.slug %}">
                  <button class="white-border-button">Edit</button>
              </a>
          {% endif %}
      </div>

    </div>
    <div class="flex-row event-set-selector"></div>
    {% if event.published_audio or event.published_video %}
        <div class="comments-container" data-subpage-url="{% url 'event_comments' pk=event.id slug=event.slug %}?set=0" data-subpage-name="comments"></div>
    {% endif %}
    </div>
    <div class="flex-column event-side">
      {% if streaming_tonight_videos %}
        <div class="event-related-videos">
          <div class="section-title section-flex">
            <div class="title1">Streaming Tonight <span class="date-separator">/</span></div>
            <div class="header-sub title2">{% now "m/d/Y" %}</div>
          </div>
          <div>
            {% for related in streaming_tonight_videos %}
              <div class="flex-row related-video">
                {% include 'events/event_card.html' with event=related mini=True show_time=True %}
                <div class="related-info flex-column content-centered">
                  <div class="flex-column">
                    <div class="text1 related-title">{{ related.title }}</div>
                    <div class="text1 text-grey">
                      {{ related.start|date:'m/d/Y' }}</div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
      <div class="event-related-videos">
        <div class="section-title section-flex">
          <div class="title1">Related videos</div>
        </div>
        <div>
          {% for related in related_videos%}
            <div class="flex-row related-video">
              {% include 'events/event_card.html' with event=related mini=True %}
              <div class="related-info flex-column content-centered">
                <div class="flex-column">
                  <div class="text1 related-title">{{ related.title }}</div>
                  <div class="text1 text-grey">{{ related.start|date:'m/d/Y' }}</div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'js/moment.min.js' %}"></script>
  <script>
  var showRegister = function() {
    $('#becomeMemberDialog').modal('show');
  };

  var showTickets = function () {
    $('#ticketsDialog').modal('show');
  };

  var goToSupporter = function() {
    window.location = '{% url 'become_supporter' %}';
  };
  </script>
  <script src="https://jwpsrv.com/library/w1FDmNWFEeS9qhJtO5t17w.js"></script>
  <script src="http://malsup.github.com/jquery.form.js"></script>

  {% if user.is_authenticated and event.sets.count %}

      <script>
        var playsCountSent = [];
        var activeTracker = null;
        function updateViewCount(player) {
          var id = player.getPlaylistItem(player.getPlaylistIndex()).mediaid;
          if (playsCountSent.indexOf(id) === -1) {
            playsCountSent.push(id);
            $.post('/multimedia/update_media_viewcount/', {
              recording_id: id,
              csrfmiddlewaretoken: '{{ csrf_token }}'

            });
          }
        }

        function updateSetText(textElement, currentItem, totalSets) {
          var setText = "Set " + currentItem + "/" + totalSets;
          $(textElement).text(setText);
        }

        {% if count_metrics %}
            var metricsSignedData = {{ metrics_signed_data|safe }};

            var pingMetricsServer = function(mediaId) {
                var data = {};
                data.signed_data = metricsSignedData[mediaId];
                data.csrfmiddlewaretoken = '{{ csrf_token }}';
                $.ajax({
                    url: "{{ metrics_server_url }}/metric/",
                    method: 'POST',
                    headers: {
                        "Authorization": "Token {{ user_token }}"
                    },
                    data: data,
                    xhrFields: {
                        withCredentials: true
                    }
                })
            };

            function setUpTimerForMedia(mediaId) {
                pingMetricsServer(mediaId);
                if (!activeTracker) {
                    activeTracker = window.setInterval(function () {
                                pingMetricsServer(mediaId);
                            }, {{ metrics_ping_interval }} * 1000
                    )
                }
            }
        {% endif %}

        {% if user.can_listen_to_audio and event.published_audio %}
          audioPlayer = jwplayer("player-audio").setup({
            primary: 'html5',
            playlist: [
              {% for audio in event.published_audio %}
                {
                  sources: [{
                    file: "{{ audio.media_file.get_file_url|safe }}",
                    type: "mp3"
                  }],
                  image: {% include 'partials/thumbor_url.html' with photo_url=event.photo.url crop_box=event.photo_crop_box %},
                  mediaid: {{ audio.id }}
                }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ],
            width: "100%",
            height: 200
          });
          audioPlayer.on('play', function () {
            {% if user.can_watch_video and event.published_videos %}videoPlayer.pause(true);{% endif %}
            updateViewCount(this);
            {% if count_metrics %}
                if (! activeTracker) {
                    setUpTimerForMedia(this.getPlaylistItem(this.getPlaylistIndex()).mediaid);
                }
            {% endif %}
          });
          {% if count_metrics %}
              audioPlayer.on('pause', function() {
                  window.clearInterval(activeTracker);
                  activeTracker = null;
              });
          {% endif %}
          audioPlayer.on('ready', function () {
            var playlist = audioPlayer.getPlaylist();
            var playlistItems = "";
            $.each(playlist, function (index, item) {
              playlistItems += '<button class="';
              if (index === 0) {
                playlistItems += ' active';
              }
              playlistItems += '" data-comments-page="' + '{% url 'event_comments' pk=event.id slug=event.slug %}?set=' + index;
              playlistItems += '" data-playlist-index="' + index + '">Set ' + (index + 1) + '</button>';
            });
            $("#audio-sets-list").html(playlistItems);
          });

          $('#audio-sets-list').on('click', 'button', function () {
            var currentIndex = audioPlayer.getPlaylistIndex();
            var selectedIndex = $(this).data('playlist-index');
            audioPlayer.playlistItem(selectedIndex);
            $('#set-number').html(selectedIndex + 1);
            $(this).toggleClass('active');
            $('#audio-sets-list button[data-playlist-index=' + currentIndex + ']').toggleClass('active');
          });
        {% endif %}

        {% if user.can_watch_video and event.published_videos %}
            videoPlayer = jwplayer("player-video").setup({
                primary: 'html5',
                playlist: [
                    {% for video in event.published_videos %}{% if video.media_file.sd_video_file %}
                    {
                        sources: [{
                            file: "{{ video.media_file.get_sd_video_url|safe }}",
                            type: "mp4"
                        }],
                        mediaid: {{ video.id }},
                        image: {% include 'partials/thumbor_url.html' with photo_url=event.photo.url crop_box=event.photo_crop_box %}
                    }{% if not forloop.last %},{% endif %}
                    {% endif %}{% endfor %}
                ],
                skin: "https:{% static "jwplayer-skin/smalls.xml" %}",
                width: "100%",
                height: 525  // If you change this please be kind and change the corresponding css.
            });
            videoPlayer.on('play', function () {
                audioPlayer.pause(true);
                updateViewCount(this);
                {% if count_metrics %}setUpTimerForMedia(this.getPlaylistItem(this.getPlaylistIndex()).mediaid);{% endif %}
                $('#playerTextOveraly').css('opacity', 0);
            });
              videoPlayer.on('pause', function() {
                {% if count_metrics %}
                  window.clearInterval(activeTracker);
                  activeTracker = null;
                {% endif %}
                  $('#playerTextOveraly').css('opacity', 1);
              });

              videoPlayer.on('ready', function () {
                var playlist = videoPlayer.getPlaylist();
                var playlistItems = "";
                $.each(playlist, function (index, item) {
                    playlistItems += '<button class="';
                    if (index === 0) {
                        playlistItems += ' active';
                    }
                    playlistItems += '" data-comments-page="' + '{% url 'event_comments' pk=event.id slug=event.slug %}?set=' + index;
                    playlistItems += '" data-playlist-index="' + index + '">Set ' + (index + 1) + '</button>';
                });
                $("#video-sets-list").html(playlistItems);
            });

            $('#video-sets-list').on('click', 'button', function () {
                var currentIndex = videoPlayer.getPlaylistIndex();
                var selectedIndex = $(this).data('playlist-index');
                videoPlayer.playlistItem(selectedIndex);
                $('#set-number').html(selectedIndex + 1);
                $(this).toggleClass('active');
                $('#video-sets-list button[data-playlist-index=' + currentIndex + ']').toggleClass('active');
            });
        {% endif %}

        {% if event.is_live or event.is_today %}
          {% if next_streaming %}
              console.log('Setting Timer')
            var changeTime = moment("{{ next_streaming.start.isoformat }}");
            var waitTime = changeTime.diff(moment(), 'miliseconds');
            var intervalId = setInterval(function () {
                clearInterval(intervalId);
                window.location = "{{ next_streaming.event_url }}";
            }, waitTime);
          {% endif %}
        {% endif %}

        var togglePlayerAudio = $("#togglePlayerAudio");
        var videoContainer = $("#videoContainer");

        var togglePlayerVideo = $("#togglePlayerVideo");
        var audioContainer = $("#audioContainer");

        var togglePlayer = function () {
          $(videoContainer).toggle();
          $(togglePlayerVideo).toggle();
          $('#video-set-buttons').toggle();

          $(audioContainer).toggle();
          $(togglePlayerAudio).toggle();
          $('#audio-set-buttons').toggle();

          // Update comments page.
          var url = $('button[data-playlist-index]:visible.active').data('comments-page');
          subpages.get('comments').setUrl(url);
        };

        {% if event.published_videos %}
          togglePlayerAudio.on('click', togglePlayer);
          togglePlayerVideo.on('click', togglePlayer);
        {% else %}
          togglePlayer();
          $(togglePlayerVideo).prop('disabled', true);
          $(togglePlayerVideo).addClass('active');
        {% endif %}
      </script>
  {% endif %}
    {% with album=event.products.first %}
        {% if album and album.tracks %}
            <script>
                var tracksPlayer = jwplayer("player-tracks").setup({
                    primary: 'html5',
                    playlist: [
                        {% for track in album.tracks.all %}
                            {% if track.preview %}
                                {
                                    sources: [{
                                        file: "{{ track.get_track_preview_url|safe }}",
                                        type: "mp3"
                                    }],
                                    mediaid: {{ track.id }}
                                }{% if not forloop.last %},{% endif %}
                            {% endif %}
                        {% endfor %}
                    ],
                    skin: "{% static "jwplayer-skin/smalls.xml" %}",
                    width: "100%",
                    height: 0
                });
                $(".playback-control").on('click', function (e) {
                    e.preventDefault();
                    if (tracksPlayer.getPlaylistIndex() == $(this).data('playlist-id')) {
                        tracksPlayer.pause();
                    } else {
                        tracksPlayer.playlistItem($(this).data('playlist-id'));
                        $('.playback-control i').removeClass('fa-pause').addClass('fa-play');
                    }
                    $(this).find('i').toggleClass('fa-play').toggleClass('fa-pause');
                });
            </script>
        {% endif %}
    {% endwith %}

    <script>
        var Subpage = function (name) {
            this.name = name;
            this.element = $('[data-subpage-name="' + name +'"]');
        };

        Subpage.prototype.bindForms = function () {
            this.element.find('form').ajaxForm({
                type: 'post',
                success: function (response) {
                    this.element.html(response);
                    this.bindForms();
                }.bind(this),
                error: function (response) {
                    this.element.html(response);
                    this.bindForms();
                }.bind(this)
            });
        };

        Subpage.prototype.load = function () {
            this.element.html('<div class="text1">Loading  ' + this.name + '...</div>');
            $.get(this.element.data('subpage-url'), function (e) {
                this.element.html(e);
                this.bindForms();
            }.bind(this));
        };

        Subpage.prototype.setUrl = function (url) {
            this.element.data('subpage-url', url);
            this.load();
        };

        var SubpageManager = function () {
            this.subpages = {};
        };
        SubpageManager.prototype.register = function() {
            var manager = this;
            $('[data-subpage-name]').each(function () {
                var name = $(this).data('subpage-name');
                manager.subpages[name] = new Subpage(name);
            });
        };
        SubpageManager.prototype.loadAll = function() {
            Object.keys(this.subpages).forEach(function (name) {
                this.subpages[name].load();
            }.bind(this));
        };
        SubpageManager.prototype.get = function(name) {
            return this.subpages[name];
        };

        var subpages = new SubpageManager();
        subpages.register();
        subpages.loadAll();

        $(document).on('click', '[data-playlist-index]', function (ev) {
            var url = $(this).data('comments-page');
            subpages.get('comments').setUrl(url);
        });

    </script>
{% endblock %}
