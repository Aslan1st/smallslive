{% extends "smalls_base.html" %}
{% load static from staticfiles %}
{% load thumbor_tags %}

{% block schedule_nav_active %}active{% endblock %}

{% block extra_head %}
  <meta property="og:url" content="{{ request.build_absolute_uri }}" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="SmallsLIVE" />
  <meta property="og:title" content="{{ event.full_title }}" />
  <meta property="og:description" content="{{ event.listing_date|date:"l, F j, Y" }} {{ event.start|date:"g:i A" }} - {{ event.end|date:"g:i A" }}" />
  {% if event.photo %}
    <meta property="og:image" content="{% thumbor_url event.photo.url|urlencode height=315 width=600 smart=True %}" />
    <meta itemprop="image" content="{% thumbor_url event.photo.url|urlencode height=315 width=600 smart=True %}">
  {% endif %}
  <meta property="fb:app_id" content="{{ facebook_app_id }}" />
  <meta itemprop="name" content="{{ event.full_title }}">
  <meta itemprop="description" content="{{ event.listing_date|date:"l, F j, Y" }} {{ event.start|date:"g:i A" }} - {{ event.end|date:"g:i A" }}">
{% endblock %}

{% block content %}

    <div class="content-wrapper">
        <section id="event-view-header" class="event-view__header container">
            <div class="event-view__header__info">
                <div class="event-view__header__bg-photo">
                    {% if event.photo %}
                        {% if event.photo_crop_box %}
                            <img src="{% thumbor_url event.photo.url|urlencode crop=event.photo_crop_box width=980 %}" alt="" class="event__img img-responsive"/>
                        {% else %}
                            <img src="{% thumbor_url event.photo.url|urlencode height=400 width=980 %}" alt="" class="event__img img-responsive"/>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="event-view__header__info__container">
                    <div class="col-xs-12 col-sm-8 event-view__header__meta">
                        <span class="event-view__header__meta__time">{{ event.listing_date|date:"l, F j, Y" }}<span>|</span>{{ event.start|date:"g:i A" }} - {{ event.end|date:"g:i A" }}</span>
                        <h1 class="event-view__header__meta__title">{{ event.title }} {% if request.user.is_staff %}(ID: {{ event.id }}){% endif %}</h1>
                        <h3 class="event-view__header__meta__subtitle">Subtitle: {{ event.subtitle }}</h3>
                    </div>
                    <div class="col-xs-12 col-sm-4 event-view__header__video-link__container">
                        <div class="event-view__header__video-link">
                            <i class="fa fa-play-circle event-view__header__video-link__icon"></i>
                            <p>Event video available</p>
                            <p class="smaller">Upgrade to a premium account to gain access to event video streaming.</p>
                            <a href="#" class="event-view__header__video-link__cta">Click to upgrade</a>
                        </div>
                    </div>
                    <div class="col-xs-12 event-view__header__track">
                        <div class="col-xs-12 col-sm-6 col-md-4 event-view__header__track__info">
                            <p>Listen to event audio recording:</p>
                        </div>
                        <div id="player-audio" class="col-xs-12 col-sm-6 col-md-8 event-view__header__track__player">
                        </div>
                    </div>
                </div>
            </div>
            <div class="event-view__header__video">

            </div>
        </section>
        <section class="event-view__details container">
            <div class="row">
                <div class="col-xs-12 col-md-4 col-md-push-8 event-view__details__share">
                    <div class="share-social">
                        <h3>Share this event on:</h3>
                        <a href="https://www.facebook.com/dialog/share?app_id={{facebook_app_id}}&display=popup&href={{ request.build_absolute_uri|urlencode }}&redirect_uri={{ request.build_absolute_uri|urlencode }}"
                         class="btn social-btn social-btn--facebook" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="fa fa-facebook"></i></a>
                        <a href="https://twitter.com/share?url={{ request.build_absolute_uri|urlencode }}&text={{ "Check out "|urlencode }}{{ event.title }}{{ " show on SmallsLIVE:"|urlencode }}&hashtags=SmallsLIVE"
                          class="btn social-btn social-btn--twitter" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="fa fa-twitter"></i></a>
                        <a href="https://plus.google.com/share?url={{ request.build_absolute_uri|urlencode }}" class="btn social-btn social-btn--google"
                       onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i
                            class="fa fa-google-plus"></i></a>
                    </div>
                </div>
                <div class="col-xs-12 col-md-8 col-md-pull-4 event-view__details__description">
                    {% if event.description %}
                        <h3>Event description:</h3>
                        <p>{{ event.description|safe }}</p>
                    {% endif %}
                    {% if user.is_superuser %}
                        <div class="event-view__details__admin">
                            <a href="{% url "event_edit" pk=event.id slug=event.slug %}" class="event-view__details__admin__button button-edit">edit event</a>
                            <form action="{% url "event_clone" pk=event.id slug=event.slug %}" method="post">
                                {% csrf_token %}
                                <input class="event-view__details__admin__button button-clone" type="submit" value="Clone">
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>
        <section class="event-view__artists container">

        </section>
        <section class="event-view__tracks container">

        </section>
        <section class="event-view__store container">

        </section>
    </div>
{% endblock content %}

{% block extra_js %}
  <script src="https://jwpsrv.com/library/w1FDmNWFEeS9qhJtO5t17w.js"></script>
    <script>
      var playsCountSent = [];
      function updateViewCount(state) {
        var id = this.getPlaylistItem(this.getPlaylistIndex()).mediaid;
        if (playsCountSent.indexOf(id) === -1) {
          playsCountSent.push(id);
          $.post('/multimedia/update_media_viewcount/', {
            recording_id: id,
            csrfmiddlewaretoken: '{{ csrf_token }}'

          });
        }
      }

      {% if user.can_listen_to_audio and event.published_audio %}
      jwplayer("player-audio").setup({
        primary: 'html5',
        playlist: [
          {% for audio in event.published_audio %}
            {
              sources: [{
                file: "{{ audio.media_file.get_file_url|safe }}"
              }],
              title: "{{ event.title }}: Set {{ audio.set_number }}",
              mediaid: {{ audio.id }}
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        skin: "{% static "jwplayer-skin/smalls.xml" %}",
        width: "100%",
        height: 30
      });
      jwplayer('player-audio').onPlay(updateViewCount);
      {% endif %}

      {% if user.can_watch_video and event.published_videos %}
      jwplayer("player-video").setup({
        primary: 'html5',
        playlist: [
          {% for video in event.published_videos %}
            {
              sources: [{
                file: "{{ video.media_file.get_sd_video_url|safe }}"
              }],
              title: "{{ event.title }}: Set {{ video.set_number }}",
              mediaid: {{ video.id }}
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        skin: "{% static "jwplayer-skin/smalls.xml" %}",
        {% if event.published_videos|length > 1 %}
        listbar: {
          position: "bottom",
          layout: 'basic',
          size: 90
        },
        {% endif %}
        width: "100%",
        height: 450
      });
      jwplayer('player-video').onPlay(updateViewCount);
      {% endif %}
    </script>
{% endblock %}