{% extends "home_new.html" %}
{% load static from staticfiles %}
{% load basket_tags currency_filters tz %}
{% load thumbor_tags %}
{% load thumbnail %}
{% load currency_filters %}
{% load i18n %}
{% load purchase_info_tags %}
{% load basket_tags %}
{% load crispy_forms_tags %}

{% block schedule_nav_active %}active{% endblock %}

{% block title %}{{ event.title }}{% endblock %}

{% block extra_head %}
  <meta property="og:url" content="{{ request.build_absolute_uri }}"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="SmallsLIVE"/>
  <meta property="og:title" content="{{ event.full_title }}"/>
  <meta property="og:description"
        content="{{ event.listing_date|date:'l, F j, Y' }} {{ event.get_date|date:'g:i A' }} - {{ event.get_date|date:'g:i A' }}"/>
  {% if event.photo %}
    <meta property="og:image" content="https:{% thumbor_url event.get_photo_url|urlencode height=315 width=600 smart=True %}"/>
    <meta itemprop="image" content="https:{% thumbor_url event.get_photo_url|urlencode height=315 width=600 smart=True %}">
  {% endif %}
  <meta property="fb:app_id" content="{{ facebook_app_id }}"/>
  <meta itemprop="name" content="{{ event.full_title }}">
  <meta itemprop="description"
        content="{{ event.listing_date|date:'l, F j, Y' }} {{ event.get_date|date:'g:i A' }} - {{ event.get_date|date:'g:i A' }}">
{% endblock %}

{% block home_content %}

  <div class="event-page-container">
    <div class="flex-column flex event-container">

      {% block event_content %}
      {% endblock %}

      <div class="event-video-info content-space-between">
        <div class=" flex-column info-container">
          <div class="event-set-info">
            <div class="current-event event-title title1">{{ event.title }}</div>
            {% if event.is_past %}
              <div class="{{ event.venue.name|lower}}-color title2">{{ event.venue.name }}</div>
            {% endif %}
            {% if event.is_future %}
              <div class="{{ event.venue.name|lower}}-color title2">Live at {{ event.venue.name }}</div>
            {% endif %}

            {% if next_event %}
              <div class="next-event event-title title1 hidden">
                {{ next_event.title }}</div>
              <div class="next-event accent-color text7 hidden">
                {{ next_event.get_date|date:'m/d/Y' }}</div>
            {% endif %}
          </div>
          <div class="event-overlay-venue">

            <div class="title5">
              {% if event.is_future %}
                {{ event.get_date|date:'D M d' }}
              {% else %}
                {{ event.get_date|date:'m/d/Y' }}
              {% endif %}
              {% if sets and event.is_future %}
                <span class="accent-color"> / </span>
                Sets at
                {% for set in sets %}
                  <span class="event-overlay-venue-set">
                    {{ set.start|time:'g:iA'}}
                  </span>
                {% endfor %}
              {% endif %}
            </div>

          </div>
        </div>
        <div class="flex-column buttons-container">
          {% block control_buttons %}
          {% endblock %}
          <div class="event-player-buttons text-right">
            {% if user.is_admin or user.is_staff %}
              <a href="{% url 'event_edit' pk=event.id slug=event.slug %}" style="display: inline-block;">
                  <button class="white-border-button">Edit</button>
              </a>
            {% endif %}
            {% if not event.is_live and event.is_past %}
              {% if user.has_archive_access %}
                <button id="one-time-donation-btn" class="white-border-button" style="display: inline;">Sponsor This Artist</button>
              {% endif %}
            {% endif %}
            {% if not event.is_live and event.is_future %}
            {% if products %}
            {% for product in products %}
            
            {% purchase_info_for_product request product as session %}
            {% basket_form request product 'single' as basket_form %}
            <form action="{% url 'basket:add' pk=product.pk %}" class="reservation_form" method="post">
              {% csrf_token %}
              {{ basket_form.as_p }}
              <input type="hidden" name="next" value="{% url 'basket:summary' %}"/>
              {% if session.availability.num_available > 0 %}
                <button type='submit' class="buy-tickets white-border-button" style="display: inline;">Tickets for {{ product.set }} ({{ session.availability.num_available }} available)</button>
              {% else %}
                <button class="white-border-button" disabled style="display: inline;">Tickets sold out)</button>
              {% endif %}
            </form>
            
            {% endfor %}
            {% else %}
              <button id="btn-tickets" class="white-border-button" style="display: inline;">Tickets</button>
            {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="event-band">
        {% for artist_dict in event_artists %}
          <div class="current_event">
            <a href="{{ artist_dict.absolute_url }}" class="artist-link">
              {{ artist_dict.name }} / {{ artist_dict.role }}</a>
          </div>
        {% endfor %}
        {% if next_event %}
          {% for artist_dict in next_event.artists_info %}
            <div class="next-event hidden">
              <a href="{{ artist_dict.absolute_url }}" class="artist-link">
                {{ artist_dict.name }} / {{ artist_dict.role }}</a>
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <div class="flex-row event-set-selector"></div>
      {% if event.published_audio or event.published_video %}
      <div class="comments-container" data-subpage-url="{% url 'event_comments' pk=event.id slug=event.slug %}?set=0" data-subpage-name="comments"></div>
      {% endif %}
    </div>
    <div class="flex-column event-side">
      {% if streaming_tonight_videos %}
      <div class="event-related-videos">
        <div class="section-title section-flex">
          <div class="title1">Streaming Tonight <span class="date-separator">/</span></div>
          <div class="header-sub title2">{% now "m/d/y" %}</div>
        </div>
        <div>
            <div>
            {% for related in streaming_tonight_videos %}
              <div class="flex-row related-video{% if related == event %} selected{% endif %}{% if next_event and next_event.title == related.title %} next-up{% endif %}">
                {% if next_event and next_event.title == related.title %}
                {% include 'events/event_card.html' with event=related mini=True show_time=True next_up=True %}
                {% elif related == event %}
                {% include 'events/event_card.html' with event=related mini=True show_time=True current_event=True %}
                {% else %}
                {% include 'events/event_card.html' with event=related mini=True show_time=True %}
                {% endif %}

                <div class="related-info flex-column content-centered">
                  <div class="flex-column">
                    <div class="text1 related-title">{{ related.title }}</div>
                    <div class="text1 text-grey">
                      {{ related.get_date|date:'m/d/Y' }}
                    </div>
                    <div class="accent-color text-uppercase">
                        <strong class="{{ related.venue.name|lower }}-color">{{ related.venue.name }}</strong>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
            </div>
        </div>
      </div>
      {% endif %}
      <div class="event-related-videos">
        <div class="section-title section-flex">
          <div class="title1">Related videos</div>
        </div>
        <div>
          <div>
            {% for related in related_videos%}
              <div class="flex-row related-video">
                {% include 'events/event_card.html' with event=related mini=True %}
                <div class="related-info flex-column content-centered">
                  <div class="flex-column">
                    <div class="text1 related-title">{{ related.title }}</div>

                    <div class="text1 text-grey">{{ related.get_date|date:'m/d/Y' }}</div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade flow-modal" id="remove-comment" aria-hidden="true">
    <div class="modal-dialog remove-comment-modal">
      <div class="modal-content custom-modal">
        <a href="#" class="close-button"></a>
        <div class="modal-body">
           <div class="title1">Removing comments</div>
            <div class="current-event accent-color text7">Are you sure to remove this comment?</div>
           <form action="{% url 'remove_comment'%}" method="post">
              {% csrf_token %}
              <button type="submit" name="id" value="" class="white-border-button">Confirm</button>
              <button onclick="$('#remove-comment').modal('hide')" class="white-border-button">Cancel</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% include 'account/artist_support_confirmation_dialog.html' %}
{% endblock %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'js/moment.min.js' %}"></script>
  <script>
  var showRegister = function() {
    $('#becomeMemberDialog').modal('show');
  };
  </script>
  <script src="https://jwpsrv.com/library/w1FDmNWFEeS9qhJtO5t17w.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
  <script src="{% static 'js/subpages.js' %}"></script>
  <script>

    $(document).ready(function () {

      var subpages = window.subpages;
      subpages.register();
      subpages.loadAll();
      
      $(document).on('click', '.remove-comment', function () {
        $('#remove-comment').modal('show',true)
        $('#remove-comment button').val($(this).data("value"))
      })

      $(document).on("click", "#confirmDonationButton", function () {
        var flowType = "event_support";
        var eventId = {{ event.pk }};
        window.location = "{% url 'become_supporter' %}?flow_type=" + flowType + "&event_id=" + eventId;
      });

      var $donationConfirmationDialog = $("#supportConfirmationDialog");
      $('#one-time-donation-btn').on('click', function () {
        $donationConfirmationDialog.modal("show");
      });

    });

    $(document).on('click', '[data-playlist-index]', function (ev) {
        var subpage = subpages.get('comments');
        if (subpage) {
          subpage.setUrl($(this).data('comments-page'));
        }
    });

    
  </script>

  {% with album=event.products.first %}
      {% if album and album.tracks %}
          <script>
              var tracksPlayer = jwplayer("player-tracks").setup({
                  primary: 'html5',
                  playlist: [
                      {% for track in album.tracks.all %}
                          {% if track.preview %}
                              {
                                  sources: [{
                                      file: "{{ track.get_track_preview_url|safe }}",
                                      type: "mp3"
                                  }],
                                  mediaid: {{ track.id }}
                              }{% if not forloop.last %},{% endif %}
                          {% endif %}
                      {% endfor %}
                  ],
                  skin: "{% static "jwplayer-skin/smalls.xml" %}",
                  width: "100%",
                  height: 0
              });
              $(".playback-control").on('click', function (e) {
                  e.preventDefault();
                  if (tracksPlayer.getPlaylistIndex() == $(this).data('playlist-id')) {
                      tracksPlayer.pause();
                  } else {
                      tracksPlayer.playlistItem($(this).data('playlist-id'));
                      $('.playback-control i').removeClass('fa-pause').addClass('fa-play');
                  }
                  $(this).find('i').toggleClass('fa-play').toggleClass('fa-pause');
              });
          </script>
      {% endif %}
  {% endwith %}

{% endblock %}
