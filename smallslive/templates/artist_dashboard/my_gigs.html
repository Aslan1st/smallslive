{% extends "artist_dashboard/home.html" %}
{% load add_get_parameter %}
{% load static from staticfiles %}
{% load thumbor_tags %}

{% block my-events-active %}active{% endblock %}

{% block title %}My events{% endblock %}


{% block content %}
    {% include 'artist_dashboard/publish_modal.html' %}

{#    TODO Move container to dashboard base#}
    <div class="artist-profile-container flex-column">
        <div class="modal fade event-mobile-info" id="event-info-modal" style="width:100%; height:90%;padding:0;" ></div>
            <div class="refine-container flex-row">
            <div class="refine text1 flex-grow"><span id="filter-number" class="accent-color">(0)</span>Refine</div>
            <div class="reset text1">Reset</div>
            </div>
        <div class="artist-archive-filter flex-row">
            <div class="white-border-select">
                <select id="artist_archive_status_filter">
                    <option value="all">Date</option>
                    <option value="leader">Leader</option>
                    <option value="sidemusician">Sidemusician</option>
                </select>
            </div>
            <div class="white-border-select">
                <select id="artist_archive_status_filter">
                    <option value="all">Status</option>
                    <option value="leader">Public</option>
                    <option value="sidemusician">Private</option>
                </select>
            </div>
            <div class="white-border-select">
                <select id="artist_archive_order">
                    <option value="newest">Sort by</option>
                    <option value="newest">Newest to oldest</option>
                    <option value="oldest">Oldest to newest</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>
            <div class="white-border-select">
                 <select id="artist_archive_order">
                    <option value="newest">Reset all</option>
                
                </select>
            </div>
            
        </div>
        <div id="artistEventsContainer" class="flex-row items-flex-stretch artist-events-container">
            <div id="artistEventsList" class="flex-column items-flex-stretch artist-events-list">
               
            </div>
            <div id="artistEventsInfo" class="flex-column items-flex-stretch artist-events-list-info"></div>
        </div>
        
    </div>
    <div id="myNav" class="refine-overlay">

            <div class="refine-overlay-menu white-line-bottom">
              <div><a href="javascript:void(0)" class="closebtn">&times;</a></div>
              <div class="calendar-refine-menu-item text1">Refine</div>
              <div class="refine-apply calendar-refine-menu-item text1">Apply</div>
            </div>
          
              <div class="refine-overlay-content">
               
          
                  <p class="calendar-refine-title title1">Date Range</p>
                  <div class="refine-datepicker-container">
                      <div class="custom-date-picker search-date-picker-from-refine" id="search-date-picker-from-refine">
                          <input class="date-picker-text" type="text" placeholder="Select date" readonly>
                      </div>
              
                      <div class="custom-date-picker" id="search-date-picker-to-refine">
                          <input class="date-picker-text" type="text" placeholder="Select date" readonly>
                      </div>
                  </div>
          
                  <p class="calendar-refine-title title1">Status</p>
          
                  <span class="btngroup text2 refine-dashboard-buttons">
                      <button value="leader" class="btngroup--btn">Leader</button>
                      <button value="sidemusician" class="btngroup--btn">Side musician</button>
                    <button value="all" class="btngroup--btn">All</button>
                  </span>
                
                  <p class="calendar-refine-title title1">Sort By</p>
                  <div class="white-border-select event-filter-select calendar-duration">
                      <select id="refine-period-filter">
                        <option value="newest">Newest to oldest</option>
                        <option value="oldest">Oldest to newest</option>
                        <option value="popular">Most Popular</option>
                      </select>
                    </div>

                  <div class="reset-all text2 text-grey">Reset All</div>
          
              </div>
            
            </div>
{% endblock content %}

{% block extra_js %}
    <script>
        
        {% if is_future %}
            eventsUrl = "{% url 'artist_dashboard:my_future_events_ajax' %}";
        {% else %}
            eventsUrl = "{% url 'artist_dashboard:my_past_events_ajax' %}";
        {% endif %}
        var selectedSetId;
        var currentPage = 0;
        var totalPages = 1;

        function askPrivate(setId) {
            $('#privateConfirm').modal('show');
            selectedSetId=setId;
        }

        function askPublish(setId) {
            $('#publishConfirm').modal('show');
            selectedSetId=setId;
        }
        function makeSetPrivate() {
            $.post('/events/sets/' + selectedSetId + '/private/', {
              csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function (data, status) {
                console.log(status);
            });
            hideMakePrivate();
            $("#set-id-" + selectedSetId).find('.publish-button').replaceWith(
                '<button class="publish-button" onclick="askPublish(' + selectedSetId + ')">Publish</button>'
            )
            $("#set-id-" + selectedSetId).find('.set-status').text('Hidden')
            showSuccess('private')
        }

        function showSuccess(state) {
            var $publishSuccess = $('#publishSuccess');
            $publishSuccess.find('.success-state').text(state);
            $publishSuccess.modal('show')
        }

        function publishSet() {
            $.post('/events/sets/' + selectedSetId + '/publish/', {
              csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function(data, status) {
                console.log(status);
            });
            hidePublish();
            $("#set-id-" + selectedSetId).find('.publish-button').replaceWith(
                '<button class="publish-button" onclick="askPrivate(' + selectedSetId + ')">Make Private</button>'
            )
            $("#set-id-" + selectedSetId).find('.set-status').text('Published');
            showSuccess('public')
        }

        function hideMakePrivate() {
            $('#privateConfirm').modal('hide');
        }

        function hidePublish() {
            $('#publishConfirm').modal('hide');
        }

        function hideSuccess() {
            $('#publishSuccess').modal('hide');
        }

        function showSelectFormat(videoUrl, audioUrl) {
            var $downloadFormat = $('#downloadFormat');
            var audioButton = $downloadFormat.find('#downloadFormatAudioUrl');
            var videoButton = $downloadFormat.find('#downloadFormatVideoUrl');

            if (audioUrl !== '') {
                audioButton.attr({href: audioUrl}).on('click', function () {
                    $downloadFormat.modal('hide');
                });
                audioButton.find('button').prop('disabled', false);
            } else {
                audioButton.find('button').prop('disabled', true);
            }

            if (videoUrl !== '') {
                videoButton.attr({href: videoUrl}).on('click', function () {
                    $downloadFormat.modal('hide');
                });
                videoButton.find('button').prop('disabled', false);
            } else {
                videoButton.find('button').prop('disabled', true);
            }
            $downloadFormat.modal('show');
        }

        function loadMore() {
            var params = {};
            if (currentPage >= totalPages) {
                return;
            }
            params.page = ++currentPage;

            var isLeader = $('#artist_archive_status_filter').val();
            if (isLeader !== 'all') {
                params.leader_filter = isLeader === 'leader';
            }

            var order = $('#artist_archive_order').val();
            if (order !== 'newest') {
                params.order = order;
            }
            
            $.ajax({
                url: eventsUrl,
                data: params,
                dataType: 'json',
                success: function (data) {
                    if (data.template) {
                        if (currentPage > 1) {
                            $("#artistEventsList").append(data.template)
                        } else {
                            $("#artistEventsList").html(data.template)
                        }
                    }

                    if (data.total_pages) {
                        totalPages = data.total_pages;
                        if (currentPage >= totalPages) {
                            $('#next-page-btn').hide()
                        } else {
                            $('#next-page-btn').show()
                        }
                    }
                }
            });
        }

        $('#artist_archive_status_filter').on('change', function () {
            currentPage = 0;
            totalPages = 1;
            loadMore();
        });

        $('#artist_archive_order').on('change', function () {
            currentPage = 0;
            totalPages = 1;
            loadMore();
        });

        loadMore();
        $('#next-page-btn').on('click', function () {
            loadMore()
        })


        $(document).ready(function() {
      
            $(".refine").click(function () {
              $(".refine-overlay").show();
          });
        
          $(".closebtn").click(function () {
              $(".refine-overlay").hide();
          });})
    </script>
{% endblock %}
