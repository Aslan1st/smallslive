{% extends "artist_dashboard/home.html" %}
{% load add_get_parameter %}
{% load static from staticfiles %}
{% load thumbor_tags %}

{% block my-events-active %}active{% endblock %}

{% block title %}My events{% endblock %}


{% block content %}
    {% include 'artist_dashboard/publish_modal.html' %}

{#    TODO Move container to dashboard base#}
    <div class="artist-profile-container">
        <div class="artist-archive-filter flex-row">
{#            FIXME Remove margin#}
            <div class="white-border-select" style="width: 150px; float:none; margin-right: 20px">
                <select id="artist_archive_status_filter">
                    <option value="all">All</option>
                    <option value="leader">Leader</option>
                    <option value="sidemusician">Sidemusician</option>
                </select>
            </div>
            <div class="white-border-select" style="width: 250px; float:none">
                <select id="artist_archive_order">
                    <option value="newest">Newest to oldest</option>
                    <option value="oldest">Oldest to newest</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>
        </div>
        <div id="artistEventsContainer" class="flex-column items-flex-stretch"></div>
        <div class="page-numbers-footer">
            <button id="next-page-btn" class="white-border-button">next page</button>
            <div id="pagination"></div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'js/jquery.simplePagination.js' %}"></script>
    <script>
        var eventsUrl = "{% url reverse_ajax %}";
        var selectedSetId;

        function askPrivate(setId) {
            $('#privateConfirm').modal('show');
            selectedSetId=setId;
        }

        function askPublish(setId) {
            $('#publishConfirm').modal('show');
            selectedSetId=setId;
        }

        function makeSetPrivate() {
            $.post('/events/sets/' + selectedSetId + '/private/', {
              csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function (data, status) {
                console.log(status);
            });
            hideMakePrivate();
            $("#set-id-" + selectedSetId).find('.publish-button').replaceWith(
                '<button class="publish-button" onclick="askPublish(' + selectedSetId + ')">Publish</button>'
            )
            $("#set-id-" + selectedSetId).find('.set-status').text('Hidden')
            showSuccess('private')
        }

        function showSuccess(state) {
            var $publishSuccess = $('#publishSuccess');
            $publishSuccess.find('.success-state').text(state);
            $publishSuccess.modal('show')
        }

        function publishSet() {
            $.post('/events/sets/' + selectedSetId + '/publish/', {
              csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function(data, status) {
                console.log(status);
            });
            hidePublish();
            $("#set-id-" + selectedSetId).find('.publish-button').replaceWith(
                '<button class="publish-button" onclick="askPrivate(' + selectedSetId + ')">Make Private</button>'
            )
            $("#set-id-" + selectedSetId).find('.set-status').text('Published');
            showSuccess('public')
        }

        function hideMakePrivate() {
            $('#privateConfirm').modal('hide');
        }

        function hidePublish() {
            $('#publishConfirm').modal('hide');
        }

        function hideSuccess() {
            $('#publishSuccess').modal('hide');
        }

        function showSelectFormat(videoUrl, audioUrl) {
            var $downloadFormat = $('#downloadFormat');
            $downloadFormat.find('#downloadFormatAudioUrl').attr({href: audioUrl}).on('click', function () {
                $downloadFormat.modal('hide');
            });
            $downloadFormat.find('#downloadFormatVideoUrl').attr({href: videoUrl}).on('click', function () {
                $downloadFormat.modal('hide');
            });
            $downloadFormat.modal('show');
        }

        function loadPage(page) {

            var params = {};
            if (page > 1) {
                params.page = page;
            }

            var isLeader = $('#artist_archive_status_filter').val();
            if (isLeader !== 'all') {
                params.leader_filter = isLeader === 'leader';
            }

            var order = $('#artist_archive_order').val();
            if (order !== 'newest') {
                params.order = order;
            }

            $.ajax({
                url: eventsUrl,
                data: params,
                dataType: 'json',
                success: function (data) {
                    if (data.template) {
                        $("#artistEventsContainer").html(data.template)
                    }

                    if (data.total_pages) {
                        $('#pagination').pagination('setPagesCount', data.total_pages);
                        $('#pagination').pagination('redraw');
                        if (data.total_pages === 1) {
                            $('#next-page-btn').prop('disabled', true)
                        } else {
                            $('#next-page-btn').prop('disabled', false)
                        }
                    }
                }
            });
        }

        $('#artist_archive_status_filter').on('change', function () {
           loadPage(1);
        });

        $('#artist_archive_order').on('change', function () {
           loadPage(1);
        });

        loadPage(1);

        $('#pagination').pagination({
            pages: 1,
            displayedPages: 3,
            edges: 1,
            hrefTextPrefix: '',
            selectOnClick: false,
            useAnchors: false,
            prevText: '', nextText: '',
            onPageClick: function (page, event) {
                loadPage(page);
            }
        });

        $('#next-page-btn').on('click', function () {
            $('#pagination').pagination('nextPage');
        })
    </script>
{% endblock %}
