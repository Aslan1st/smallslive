{% load static from staticfiles %}
{% load fromisoformat %}

{% with set=event_set %}
<div data-url="{% url  'artist_dashboard:my_past_events_info' pk=event.id %}">

    <div class="artist-set-actions">
        
        <div class="button-row button-row-margin">
            {% if is_admin and set.has_media %}
                <a href="{% url 'artist_dashboard:event_edit' pk=event.id slug=event.slug %}">
                    <button class="set-button">Edit</button>
                </a>
                {% if set.video_recording and set.video_recording.is_published or set.audio_recording and set.audio_recording.is_published %}
                <button id="private-button" class="publish-button set-button" onclick="askPrivate({{ set.id }})"> Public </button>
                {% else %}
                <button id="public-button" class="publish-button set-button" onclick="askPublish({{ set.id }})"> Private </button>
                {% endif %}
            {% else %}
                <button disabled class="set-button">Edit</button>
                {% if set.video_recording and set.video_recording.is_published %}
                    <button disabled class="set-button">Public</button>
                {% else %}
                    <button disabled class="set-button">Private</button>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="header-metrics-container">
        <div class='artist-set-main'>
            <div class="artist-event-info flex-column wrap">
                <div class="flex-row artist-set-header">
                    <div class="artist-event-arrow" onclick="closeEvent()">
                        <img src="/static/image/arrow-right-red.svg" alt="arrow-red">    
                    </div>
                    <div class="artist-set-info-mobile">
                            <div class="text2"> {{ event.date|date:'m/d/Y' }} </div>
                            <div class="text2"> {{ event.title }} </div>
                            <div class="text2 accent-color"> Live at {{ event.venue }} </div>
                    </div>
                    <div class="artist-set-info">
                        <div class="text2"> {{ event.date|date:'m/d/Y' }} </div>
                        <div class="text2"> {{ event.title }} </div>
                    </div>
                <div class='artist-set-download'>
                    <img  src="{% static '/static/image/download-icon.svg' %}" alt="" onclick="showSelectFormat('{{ set.video_recording.media_file.get_downloadable_sd_video_url }}', '{{ set.audio_recording.media_file.get_downloadable_file_url }}')">
                </div>
            </div>
            <div class="artist-event-card">
                <a href="{{ event.get_absolute_url }}">
                    <div class="set-picture-container flex-column">
                        <div class="set-icon-overlay text2">
                            <i class="fa fa-play fa-thin-circle"></i>
                        </div>
                        <div class="picture-border">
                            <div class="set-picture">
                                {% if event.photo %}
                                  {% include 'partials/thumbored_picture.html' with photo_url=event.get_photo_url crop_box=event.photo_crop_box %}
                                {% else %}
                                  {% include 'partials/thumbored_picture.html' %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        <div class="artist-set-list flex-row">
            {% for set in event.sets.all %}
                <div data-url="{% url  'artist_dashboard:my_past_events_info' pk=event.id %}?set_id={{ forloop.counter0 }}" class="{% if set.id == event_set.id %} artist-active-set accent-color {% endif %}set-changer">
                    <div class="text2 flex-column flex-grow "> Set {{ forloop.counter0|add:"1" }} </div>
                </div>
            {% endfor %}
        </div>
    </div>
    </div>
    <div class="artist-metrics-container">
        <div class="datepicker-container noclick datepicker-dashboard-container">
            <div class="datepicker-dashboard-left-panel">
                {% for range in datepicker_ranges %}
                <div class="datepicker-dashboard-left-panel-item text5 hover-fade" data-date="{{ range.date }}" data-start="{{ range.start }}" data-end="{{ range.end }}">{{ range.content }}</div>
                {% endfor %}
            </div>

            <div class="custom-date-picker" id="search-date-picker-from">
                <input class="date-picker-text" type="text" placeholder="Select date" readonly>
            </div>
    
            <div class="custom-date-picker" id="search-date-picker-to">
                <input class="date-picker-text" type="text" placeholder="Select date" readonly>
            </div>
    
            <div class="white-border-button" id="apply-button">Apply</div>
        </div>
            
                
        <div class="artist-metrics-header white-line-bottom flex-row">
                <div class="title1 datepicker-dashboard-btn">Metrics</div>
            <div class="text2" id="datepicker-description">All Time</div>
        </div>

        <div class="event-metrics-container flex-row">
            <div class="event-metrics-container-plays event-metrics-container-data">
                <div class="text3">Plays</div>
                <div id="play-value" class="title1"></div>
            </div>
            <div class="event-metrics-container-time event-metrics-container-data">
                <div class="text3">Time Listened</div>
                <div id="time-value" class="title1"></div>
            </div>
        </div>
    </div>
    </div>

    <div class="text2 flex-column" style="padding-top: 3px;">
        <div class="artist-set-leader">
            <span class="accent-color">Leader{{ leaders|length|pluralize }}</span>
            {% for gig_played in event.get_performers %} 
            {% if gig_played.is_leader %}
                <div class="set-artist text1">
                    {{ gig_played.artist.full_name }}
                    <span class="accent-color">/</span>
                    <span>{{ gig_played.role }}</span>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        {% if sidemen %}
            <div>
                <span class='accent-color'>Side musicians</span>
                {% for gig_played in event.get_performers %}
                    {% if not gig_played.is_leader %}
                        <div class='set-artist text1'>
                            {{ gig_played.artist.full_name }}
                            <span class='accent-color'>/</span>
                            <span class=''>{{ gig_played.role }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
    </div>
    <div class="flex-column mobile-event-menu">
            <div id="mobile-metrics-button"class="flex-row mobile-event-opt">
            <div class="white-border-button">Metrics</div>
                {% if is_admin and set.has_media %}
                    {% if set.video_recording and set.video_recording.is_published or set.audio_recording and set.audio_recording.is_published %}
                    <div id="private-button" class="white-border-button" onclick="askPrivate({{ set.id }})"> Public </div>
                    {% else %}
                    <div id="public-button" class="white-border-button" onclick="askPublish({{ set.id }})"> Private </div>
                    {% endif %}
                    <div class="white-border-button" id="table-event-edit" data-pk=event.id data-slug=event.slug onclick="">Edit</div>
                {% else %}
                    {% if set.video_recording and set.video_recording.is_published %}
                        <div class="white-border-button disabled">Public</div>
                    {% else %}
                        <div class="white-border-button disabled">Private</div>
                    {% endif %}
                    <div class="white-border-button disabled">Edit</div>
                {% endif %}
                
            </div>
            <div id="mobile-option-container">
            <div class="edit-event-mobile-form-body" data-subpage-name="tablet-edit" data-subpage-url="{% url 'artist_dashboard:event_edit' pk=event.id slug=event.slug %}">

            </div>
            <div class="modal fade edit-event-mobile-form" id="edit-event-form" style="width:80%; height:80%;" >
                    <div class="edit-event-mobile-form-body">
                            <a href="#" class="close-button"></a>
                            <img class="smalls-form-logo" src="{% static 'logo-black.svg' %}">
                            <div class="accent-color title2">Archived show</div>
                            <div class="edit-event-mobile-form-body title1">Edit event info</div>
                    </div>
                    <div class="edit-event-mobile-form-body" data-subpage-name="mobile-edit" data-subpage-url="{% url 'artist_dashboard:event_edit' pk=event.id slug=event.slug %}">
                            <a href="#" class="close-button"></a>
                    </div>

                </div>

    </div>
{% endwith %}

{% block extra_js %}

    <script src="{% static 'js/subpages.js' %}"></script>
    <script src="{% static 'js/jquery.form.js' %}"></script>
    <script>
        function closeEvent() {
            $('#event-info-modal').modal('hide');
        }
        $('#edit-event-form .close-button').click(() => { $('#edit-event-form').modal('toggle') })

        $('#table-event-edit').on('click', function () {
              window.subpages.register();
              if(window.screen.availWidth > 425){
                $('#edit-event-form').modal('show');
                var tabletSubpage = window.subpages.get("tablet-edit");
                tabletSubpage.load();
              }else{
                console.log("Mobile edit")
                var mobileSubpage = window.subpages.get("mobile-edit");
                mobileSubpage.load();
              }
        })
        $('.set-changer').on('click', function () {
            loadInfo($(this).data('url'));
        })
    </script>

    <script type="text/javascript" src="{% static 'js/moment.min.js' %}"></script>
    <script src="{% static 'js/Chart.min.js' %}"></script>
    <script src="{% static 'js/bootstrap-datepicker.js' %}"></script>

    <script>
        $('.mobile-event-opt .white-border-button').on('click', function () {
            $('.mobile-event-opt .white-border-button').css("background-color", "")
            $(this).css( "background-color", 'white' );
        })

        var eventDateFrom = new Date(2000, 0, 1);
        var eventDateTo = new Date();

        var payoutsUrl = '/dashboard/my-payouts';
        var minsData = {
            datasets: [
                {
                    label: "Total",
                    backgroundColor: "rgba(210,21,53,0)",
                    borderColor: "#ed1c24",
                    pointBackgroundColor: "#000",
                    pointBorderColor: "#000",
                    pointHoverBackgroundColor: "#fff",
                    pointHoverBorderColor: "rgba(220,220,220,1)"
                }
            ]

        };
        $(document).ready(function () {
            var plays = document.getElementById("play-value");
            var time = document.getElementById("time-value");

            var loadData = function () {
                var data = {};
                data.set_id = {{ event_set.id }};

                data.start = moment(eventDateFrom).format('YYYY-MM-DD');
                data.end = moment(eventDateTo).format('YYYY-MM-DD');

                var countsURL = "{% url 'event_counts' %}";
                $.ajax(countsURL, {
                    data: data,
                    success: function (response) {
                        plays.innerHTML= response.total_plays_list.reduce(
                            function (e, acc) {
                                return e + acc;
                            }, 0);
                        playedMinutes = response.total_minutes_list.reduce(
                            function (e, acc) {
                                return e + acc;
                            }, 0);
                        time.innerHTML = moment.utc((playedMinutes*60)*1000).format('HH:mm:ss');
                    },
                    type: 'GET',
                    xhrFields: {
                        withCredentials: true
                    }
                });
            };

        loadData();


        $(".datepicker-dashboard-left-panel > div").click(function () {
            //alert($(this).data('start'));

            if ($(this).data('date') == "all") {
                $("#search-date-picker-from input").datepicker("update", new Date(2000, 0, 1));
                $("#search-date-picker-to input").datepicker("update", new Date());
            } else if ($(this).data('date') == "period") {
                d = new Date();
                d.setFullYear(d.getFullYear() - 1);
                $("#search-date-picker-from input").datepicker("update", d);
                $("#search-date-picker-to input").datepicker("update", new Date());
            } else {
                $("#search-date-picker-from input").datepicker("update", new Date($(this).data('start')));
                $("#search-date-picker-to input").datepicker("update", new Date($(this).data('end')));
            }

            eventDateFrom = $("#search-date-picker-from input").datepicker('getDate');
            eventDateTo = $("#search-date-picker-to input").datepicker('getDate');

            $("#datepicker-description").html($(this).text());

            $("#search-date-picker-to input").click();
            $("#search-date-picker-to input").focus();
        });

        ////////////////

        $('.datepicker-dashboard-btn').bind("click", ToggleDisplay);

        function ToggleDisplay() {
            if ($(".datepicker-container").data('shown'))
                hide();
            else 
                display();
        }

        function display() {
            $(".datepicker-container").css("display", "flex").hide().fadeIn(500, function() {
                $(document).bind("click", hide);
                $(".datepicker-container").data('shown', true);
            });

            $("#search-date-picker-from input").click();
            $("#search-date-picker-from input").focus();
        }

        function hide() {   
            if (($(window.event.toElement).closest('.noclick').length == 0) &&
            (!($(window.event.toElement).hasClass("day") || $(window.event.toElement).hasClass("year")))) {
                $(".datepicker-container").fadeOut(500, function () {
                    $(document).unbind("click");
                    $(".datepicker-container").data('shown', false);
                });
            }
        }

        /////////////////////

        var $datePickerFrom = $('#search-date-picker-from input');
        $datePickerFrom.datepicker({
            format: 'mm/dd/yyyy',
            autoclose: true,
            container: '#search-date-picker-from',
            showOnFocus: false
        });

        $datePickerFrom.on('changeDate', function (newDate) {
            eventDateFrom = newDate.date;
            $("#search-date-picker-to input").click();
            $("#search-date-picker-to input").focus();
        });

        $datePickerFrom.on('click', function () {
            var dropdown = $('#search-date-picker .dropdown-menu');
            if (dropdown[0] && dropdown[0].style.display === 'block') {
                $datePickerFrom.datepicker('hide');
            } else {
                $datePickerFrom.datepicker('show');
            }
        });

        //////////////////////

        var $datePickerTo = $('#search-date-picker-to input');
        $datePickerTo.datepicker({
            format: 'mm/dd/yyyy',
            autoclose: false,
            container: '#search-date-picker-to',
            showOnFocus: false
        });

        $datePickerTo.on('changeDate', function (newDate) {
            eventDateTo = newDate.date;

            from = (eventDateFrom.getMonth() + 1) + '/' + eventDateFrom.getDate() + '/' + eventDateFrom.getFullYear();
            to = (eventDateTo.getMonth() + 1) + '/' + eventDateTo.getDate() + '/' + eventDateTo.getFullYear();

            $("#datepicker-description").html(from + " - " + to);
        });

        $datePickerTo.on('click', function () {
            var dropdown = $('#search-date-picker .dropdown-menu');
            if (dropdown[0] && dropdown[0].style.display === 'block') {
                $datePickerTo.datepicker('hide');
            } else {
                $datePickerTo.datepicker('show');
            }
        });

        ///////////

        $("#apply-button").click(function () {
            $(".datepicker-container").fadeOut(500, function () {
                $(document).unbind("click");
                $(".datepicker-container").data('shown', false);
            });

            loadData();
        });

    });

    </script>
{% endblock %}
