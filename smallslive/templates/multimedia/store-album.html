{% extends "store_base.html" %}
{% load static from staticfiles %}
{% load thumbor_tags %}
{% load thumbnail %}
{% load currency_filters %}
{% load i18n %}
{% load purchase_info_tags %}
{% load basket_tags %}


{% block store_content %}

  <section id="my-downloads-album__list">
    {% include 'multimedia/album-display.html' with album_product=album_product if_full=is_full bought_tracks=bought_tracks is_catalogue=is_catalogue mp3_available=mp3_available %}
  </section>
  <section id="my-downloads-product__purchase" class="hidden">
    {% include 'account/become-supporter.html' with catalog_flow=True %}
  </section>
  {% include 'account/catalog_selection_confirmation_dialog.html' %}
{% endblock %}


{% block extra_js %}
  <script src="https://www.paypalobjects.com/api/checkout.js"></script>
  <script src="https://js.stripe.com/v2/"></script>
  <script src="{% static 'js/card.js' %}"></script>
  <script src="{% static 'js/payment/payment.js' %}"></script>
  <script src="{% static 'js/become-member.js' %}"></script>
  <script src="{% static 'js/store-base.js' %}"></script>
  <script>

    $(document).ready(function () {

      Stripe.setPublishableKey('{{ STRIPE_PUBLIC_KEY }}');
      // in payment.js
      //renderPayPal(paypal);
      //renderCardAnimation();

    });

  </script>
  <script>
    var el, setTime;

    el = document.querySelector(".track-container");
  </script>
  <script src="https://jwpsrv.com/library/w1FDmNWFEeS9qhJtO5t17w.js"></script>
  <script src="{% static 'js/progress-bar.js' %}"></script>

  <script>
    var lastPlayer, audioPlayer, audioPlayerTrack, mainContainer, playerContainer, lastPlayerContainer, lastplayerContainerId, play;
    
     $(document).on('click', ".white-border-button.add-to-library", function(event){
         event.stopPropagation()
     });
     $(document).on('click', ".white-border-button.added-to-library", function(event){
         event.stopPropagation()
     });
    $(document).on('click', ".my-downloads-album__tracks-table__row.flex-row:not(.disabled)", function(event){
        progress = calculateProgress($(this),event)
        //find audio player, its track number and change the big player track number
        audioPlayer = $(this).find(".audio audio")[0]
        audioPlayerTrack = $(audioPlayer).data("track")
        mainContainer = $(this).closest(".big-player")[0]
        playerContainer =$(mainContainer).find(".player-container")[0]
        $(playerContainer).data("track", audioPlayerTrack)
        //make active track color red, toggles player button and remove previous track color
        var trackInfo = $(this).find(".track-info")
        lastPlayerContainerButton = $(lastPlayerContainer).find(".purchases-player-button ")
        playerContainerButton = $(playerContainer).find(".purchases-player-button")
        audioProgress = audioPlayer.currentTime / audioPlayer.duration * 100
        if( $(trackInfo).hasClass("active-track")){
            $(".active-track").removeClass("active-track")
            play = false
            $(playerContainerButton).removeClass("mypause-btn")
            $(playerContainerButton).addClass("myplay-btn")
            $(playerContainerButton).find('div').html('<i class="fas fa-play"></i>')
        }else{
            $(audioPlayer).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").addClass("active-bar")
            $(".active-track").removeClass("active-track")
            $(this).find(".track-info").addClass("active-track")
            play = true;
            $(lastPlayerContainerButton).addClass("myplay-btn")
            $(lastPlayerContainerButton).removeClass("mypause-btn")
            $(playerContainerButton).addClass("mypause-btn")
            $(playerContainerButton).removeClass("myplay-btn")
            $(playerContainerButton).find('div').html('<i class="fas fa-pause"></i>')
        }
        //toggles player
        if(lastPlayer != undefined){
            lastPlayer.pause()
            $("#" + $(lastPlayer).data("track"))
            .children(".progress-bar")
            .addClass("paused");
        }
        togglePlayer(audioPlayer, play)
        
        lastPlayerContainer = playerContainer
        lastPlayer = audioPlayer
    });
    function togglePlayer(playerContainer, play){
        if (!audioPlayer) {
            audioPlayer = $(bigContainer).find(".audio audio[data-track='0']")[0]
            $(trackInfo).first().addClass("active-track")

        }
        if(play){
            audioPlayer.play()
             $("#" + $(playerContainer).data("track"))
            .children(".progress-bar")
            .removeClass("paused");
        }else{
            audioPlayer.pause()
             $("#" + $(playerContainer).data("track"))
            .children(".progress-bar")
            .addClass("paused");
            $(".active-track").removeClass("active-track") 
        }
    }
    $(document).on('click', ".purchases-player-button", function(){
        bigContainer = $(this).closest(".big-player")[0]
        playerContainer = $(bigContainer).find(".player-container")[0]
        playerContainerButton = $(playerContainer).find(".purchases-player-button")[0]
        trackNumber = $(playerContainer).data("track")
        trackInfo = $(bigContainer).find(".track-info:not(.disabled)");
        audioPlayer = $(bigContainer).find(".audio audio[data-track='" + trackNumber +  "']")[0]
        lastPlayerContainerButton = $(lastPlayerContainer).find(".purchases-player-button ")
        if( $(trackInfo).hasClass("active-track")){
            $(trackInfo).removeClass("active-track")
            play = false
            $(playerContainerButton).removeClass("mypause-btn")
            $(playerContainerButton).addClass("myplay-btn")
            $(playerContainerButton).find('div').html('<i class="fas fa-play"></i>')
        }else{
            $(audioPlayer).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").addClass("active-bar")
            $(".active-track").removeClass("active-track")
            let tracknum = $(audioPlayer).data('track')
            $(trackInfo).filter(function() { 
                return $(this).data("track") == tracknum 
            }).addClass("active-track")
            play = true
            $(lastPlayerContainerButton).addClass("myplay-btn")
            $(lastPlayerContainerButton).removeClass("mypause-btn")
            $(playerContainerButton).addClass("mypause-btn")
            $(playerContainerButton).removeClass("myplay-btn")
            $(playerContainerButton).find('div').html('<i class="fas fa-pause"></i>')

        }
        if(lastPlayer != undefined){
            lastPlayer.pause()
             $("#" + $(lastPlayer).data("track"))
            .children(".progress-bar")
            .addClass("paused");
        }
        togglePlayer(audioPlayer, play)
        lastPlayerContainer = playerContainer
        lastPlayer = audioPlayer
    })
    var audioPlayers = document.getElementsByClassName("audio-player");
  
    function readableTime(seconds) {
        var hr = ~~(seconds / 3600);
        var min = ~~((seconds % 3600) / 60);
        var sec = seconds % 60;
        var sec_min = "";
        if (hr > 0) {
            sec_min += "" + hr + ":" + (min < 10 ? "0" : "");
        }
        sec_min += "" + min + ":" + (sec < 10 ? "0" : "");
        sec_min += "" + sec;
        return sec_min;
    }


    function calculateProgress(element, position) {
    
    var mX, mY, distance,
        $element  = $(element);

    function calculateDistance(elem, mouseX, mouseY) {
        return Math.floor(mouseX - (elem.offset().left), 2);
    }
    mX = position.pageX;
    mY = position.pageY;
    distance = Math.floor(calculateDistance($element, mX, mY) / element.width() * 100); 
    return distance  
    };
    function changeProgress(progress, player){
        newProgress = Math.floor(player.duration) * progress / 100
        player.currentTime = newProgress;
        updateProgressTrack('player', newProgress)
    }

    $(".event-display").on("click", function(){
        albumId = $(this).data("parent-pk")
        album_type = $(this).data("type")
        bought_tracks = $(this).data("bought")
        loadAlbum(albumId, bought_tracks, album_type)
    })

    var mouseEventHandler = function(ev) {
        if(ev.type == "mousemove"){
            var position = ev
        }else{
            var position = {};
            position.pageX = ev.changedTouches[0].pageX
            position.pagey = ev.changedTouches[0].pageY
        }

        dragabbleProgess = calculateProgress($(this), position) + "%"
        $(this).find(".my-downloads-album__tracks-table__row").find(".progress-bar").css("width", dragabbleProgess )

    }
    startProgressHold =  function(event){
        maincontainer = $(this).closest(".track-container")[0]
        active = $(maincontainer).find(".track-info.active-track")
        if( active.length > 0){
            if(event.type == "mousedown"){
                el.addEventListener("mousemove", mouseEventHandler)
            }else{
                el.addEventListener("touchmove", mouseEventHandler)
            }
            
            clearInterval(setTime)
        }
     
    }
    $(document).on( "touchstart",  ".length-bar", startProgressHold);
    $(document).on( "mousedown",  ".length-bar", startProgressHold);

    endProgressHold =  function(ev){
        if(ev.type == "mouseup"){
            var position = ev
        }else{
            var position = {};
            position.pageX = ev.originalEvent.changedTouches[0].pageX
            position.pagey = ev.originalEvent.changedTouches[0].pageY
        }
        maincontainer = $(this).closest(".track-container")[0]
        active = $(maincontainer).find(".track-info.active-track")
        if(active.length > 0){
             if(event.type == "mouseup"){
                el.removeEventListener("mousemove", mouseEventHandler)
            }else{
                el.removeEventListener("touchmove", mouseEventHandler)
            }
            player = maincontainer.getElementsByClassName("audio-player")[0];
            changeProgress(calculateProgress($(maincontainer), position), player)
            setTime = setInterval( t=> {
                currentTime = Math.floor(player.currentTime)
                $(player).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").addClass("active-bar")
                timeTracker = $(player).closest(".my-downloads-album__tracks-table__row").find(".my-downloads-album__tracks-table__column.duration")[0]
                progress = player.currentTime / player.duration * 100
                progressWidth = progress + "%"
                $(player).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").css("width", progressWidth )
                $(timeTracker).html(readableTime(currentTime)) 
            },100)
        }
    }

    $(document).on( "touchend",  ".length-bar", endProgressHold);
    $(document).on( "mouseup",  ".length-bar", endProgressHold);
    Array.prototype.forEach.call(audioPlayers, function(player) {
        player.addEventListener("play", function(){
                setTime = setInterval( t=> {
                currentTime = Math.floor(player.currentTime)
                $(player).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").addClass("active-bar")
                timeTracker = $(player).closest(".my-downloads-album__tracks-table__row").find(".my-downloads-album__tracks-table__column.duration")[0]
                progress = player.currentTime / player.duration * 100
                progressWidth = progress + "%"
                updateProgressTrack( $(player).data('track'), progress)
                $(player).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").css("width", progressWidth )
                $(timeTracker).html(readableTime(currentTime)) 
            },100)
            
        });
        player.addEventListener("pause", function(){
            clearInterval(setTime)
            $(player).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").removeClass("active-bar")
        });
        player.addEventListener("ended", function(){
            $(player).closest(".my-downloads-album__tracks-table__row").find(".progress-bar").removeClass("active-bar");
            $(player).closest(".big-player").find(".purchases-player-button").removeClass("mypause-btn");
            $(player).closest(".big-player").find(".purchases-player-button").addClass("myplay-btn");
            $(playerContainerButton).find('div').html('<i class="fas fa-play"></i>')
            $(".active-track").removeClass("active-track");
            player.currentTime = 0;
            clearInterval(setTime)
        });
    });



  </script>

{% endblock %}
