{% extends "smalls_base.html" %}
{% load static from staticfiles %}
{% load thumbor_tags %}
{% load common_tags %}
{% load i18n %}

{% block homepage_nav_active %}active{% endblock %}

{% block title %}Smalls Jazz Club{% endblock %}

{# TODO Shouldn't be needed here #}
{% block body_class %}home{% endblock %}

{% block extra_head %}
  <meta name="description"
        content="This is the official website for Smalls Jazz Club in Greenwich Village, New York City!">
{% endblock %}

{% block header %}
  <div class="navigation-bars">
    {% if user.is_superuser %}
      {% include 'admin_header.html' %}
    {% endif %}
    {% include 'partials/header.html' %}
    {% block extra_nav %}
    {% endblock %}
  </div>
{% endblock %}

{% block content %}
  {% include 'inactive_dialog.html' %}
  {% include 'become_a_supporter_dialog.html' %}
  {% if activation_key %}
    {% include 'artist_registration/set_password_dialog.html' %}
  {% endif %}

  <div class="main-container pad-content {% if calendar %}calendar{% else %}home-new{% endif %}">
    {% block home_content %}
    <main>
      {% include 'home_banners_carousel.html' %}
      <div class="event-stripe">
        {% include 'events/today_and_tomorrow.html' with custom_venue_style=True %}

        {% if not query_term and not artist_profile %}
          <section id="recently-added-section" class="event-stripe archive">
            <div class="section-title home archive">
              <div class="title1"><a href="#" id="ra-recently-added-toggle"  class="accent-color"> Recently Added</a>  \ <a href="#" id="ra-most-popular-toggle">Most Popular</a></div>
            </div>
            <main>
              <div class="slide-btn prev"><b class="indicator-icon icon-left-caret"></b></div>
              <div class="slide-btn next"><b class="indicator-icon icon-right-caret"></b></div>
              {% include 'events/event_row.html' with events=new_in_archive secondary=True %}
            </main>
          </section>

          <section id="most-popular-section" class="event-stripe archive hidden">
            <div class="section-title home archive">
              <div class="title1"><a href="#" id="mp-recently-added-toggle"> Recently Added</a>  \ <a href="#" id="mp-most-popular-toggle" class="accent-color">Most Popular</a></div>
              <span class="select-container" style="left: 690px; bottom: -4px;">
                <div class="white-border-select home-filter">
                  <select id="most-popular-filter">
                    <option value="alltime"{% if popular_select == 'alltime' %} selected{% endif %}>All Time</option>
                    <option value="month"{% if popular_select == 'month' %} selected{% endif %}>Last month</option>
                    <option value="year"{% if popular_select == 'year' %} selected{% endif %}>This Year</option>
                  </select>
                </div>
              </span>
            </div>
            <main id="most-popular-container">
              <div class="slide-btn prev"><b class="indicator-icon icon-left-caret"></b></div>
              <div class="slide-btn next"><b class="indicator-icon icon-right-caret"></b></div>
              {% include 'events/event_row.html' with events=popular_in_archive secondary=True %}
            </main>
          </section>

        {% endif %}

        <section class="event-stripe">
          <div class="section-title home highlights">
            <div class="title1">Highlights from the Archive</div>
          </div>
          <main>
            <div class="slide-btn prev"><b class="indicator-icon icon-left-caret"></b></div>
            <div class="slide-btn next"><b class="indicator-icon icon-right-caret"></b></div>
            {% include 'events/event_row.html' with events=staff_picks %}
          </main>
        </section>
      </div>
    </main>
    {% endblock %}
  </div>
{% endblock%}

{% block footer %}
  <!-- Removed mobile footer as per Spike's request -->
  <div style="margin: 10px 50px;">
    <footer class="footer-info flex-column items-center" style="margin-bottom: 50px;">
      <img class="footer-logo" style="margin-bottom: 5px;" src="{% static 'new_logo_transparent_black.svg' %}" alt="SmallsLIVE Foundation logo" width="100">
      <div class="text-grey">Copyright Â®{% now 'Y' %} SmallsLIVE All rights reserved.</div>
      <div>
        <a href="{% url 'static_page' 'privacy' %}">Privacy Policy</a> |
        <a href="{% url 'terms-and-conditions' %}">Terms and Conditions</a> |
        <a href="{% url 'contact-and-info' %}">Contact + Info</a>
      </div>
      {% if not current_user.newsletter %}
        <div class="newsletter">
          <p class="text4">subscribe to our newsletter</p>
          <form class="admin-interface__form flex-row" action="{% url 'newsletters' %}" method="post">
              {% csrf_token %}
              <input class="form-control" type="email" required name="email" placeholder="email address" value="{% if current_user.is_authenticated %}{{ current_user.email }}{% endif %}"/>
              <input class="white-border-button" type="submit" value="SUBSCRIBE" class="homepage-news__button"/>
          </form>
        </div>
      {% endif %}
    </footer>
  </div>
{% endblock %}

{% block extra_js %}
  {% if activation_key %}
    <script>
      $(document).ready(function () {
        // Show artist sign up form using the modal
        var  $modal = $("#artist-set-password-dialog");
        $modal.modal("show");
        var url = "{% url "artist_registration_confirm_email_ajax" key=activation_key %}";
        $.get(url, function (data) {
          $modal.find(".modal-body").html(data);
        });


        $(document).on("submit", "#artist-registration-set-password-form", function (event) {
          event.preventDefault();
          var form = $(this);
          var url = form.attr('action');

          $.ajax({
           type: "POST",
           url: url,
           data: form.serialize(),
           success: function (data) {
            if (data.location) {
              window.location.href = data.location;
            } else if (data.errors) {
              for (var key in data.errors) {
                $modal.find("#" + key + "-error").html(data.errors[key]).removeClass("hidden");
              }
            }
           }
         });

        });

      });
    </script>
  {% endif  %}

  <script>
    $(document).ready(function () {

      /* Functionality for switching between recently added and most popular
         This has been changed many times. Leaving the code here for convenience
         until there is a final decision */

      $('#ra-most-popular-toggle, #mp-most-popular-toggle').click(function (event) {
        event.preventDefault();
        $('#recently-added-section').addClass('hidden');
        $('#most-popular-section').removeClass('hidden');
        // Trigger resize to get carousel working  TODO: refactor code.
        $(window).resize();

      });

      $('#ra-recently-added-toggle, #mp-recently-added-toggle').click(function (event) {
        event.preventDefault();
        $('#recently-added-section').removeClass('hidden');
        $('#most-popular-section').addClass('hidden');
        // Trigger resize to get carousel working  TODO: refactor code.
        $(window).resize();
      });

      var popularFilterDefaultValue = "{{ popular_select }}";
      var popularQueryUrl = "{% url 'event_popular_ajax' %}";

      var $filter = $("#most-popular-filter");

      var setMostPopular = function(value) {
        var mostPopularFilter = $("#most-popular-container").find(".event-row");
        $.get(popularQueryUrl + "?range=" + value, function(data) {
          mostPopularFilter.replaceWith(data.content);
        });
      };

      $filter.on("change", function() {
        setMostPopular($filter.val());
      });

      if (typeof popularFilterDefaultValue != "undefined") {
        $filter.val(popularFilterDefaultValue);
        $filter.trigger("change");
      }

    });
  </script>

{% endblock extra_js %}
