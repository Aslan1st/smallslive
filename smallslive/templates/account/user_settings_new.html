{% extends "smalls_base.html" %}
{% load static from staticfiles %}
{% load thumbor_tags %}
{% load i18n %}
{% load djstripe_tags %}
{% block homepage_nav_active %}active{% endblock %}

{% block title %}Smalls Jazz Club{% endblock %}

{# TODO Shouldn't be needed here #}
{% block body_class %}home no-scroll{% endblock %}

{% block extra_head %}
	<meta name="description"
				content="This is the official website for Smalls Jazz Club in Greenwich Village, New York City!">
{% endblock %}

{% block header %}
{% include 'partials/header.html' %}
{% endblock %}

{% block content %}
{% include 'inactive_dialog.html' %}
{% include 'become_a_supporter_dialog.html' %}




<div class="account-settings-container-new flex-row">
	<div class="account-settings-info-container">
		<div class="flex-column">
			<div id="user-account" class="account-settings-view">
				<div class="title5 account-settings-title text-bottom-line">Account info</div>
				<div data-toggle-tab="user-account-info" data-toggle-tab-group="user-account">
					<div class="account-settings-info">
							<div class="text5">Name</div>
							<div class="text9 text-grey">{{user.first_name}} {{user.last_name}}</div>
						</div>
						<div class="account-settings-info">
							<div class="text5">Email</div>
							<div class="text9 text-grey">{{user.email}}</div>
						</div>
						<div class="account-settings-info">
							<div class="text5">Password</div>
							<div class="text9 text-grey">xxxxxxxxxx</div>
						</div>
						<button class="white-border-button" data-toggle-tab-target="user-account-form" data-toggle-tab-group="user-account"">Edit info</button>
				</div>
				<div data-toggle-tab="user-account-form" data-toggle-tab-group="user-account" style="display:none">
						{% include 'account/account-change-form.html' %}
				</div>		
			</div>
			{% if request.user.artist %}
			<div id="user-payout" class="account-settings-view">
				<div class="title5 account-settings-title text-bottom-line">Payout info</div>
				<div data-toggle-tab-group="user-payout" data-toggle-tab="user-payout-info">
					<div class="account-settings-info">
						<div class="text5">Mailing address</div>
							{% if user.address_1 or user.address_2 or user.city %}
								<div class="text9 text-grey">{{ user.address_1 }}</div>
								<div class="text9 text-grey">{{ user.address_2 }}</div>
								<div class="text9 text-grey">{{user.city }}</div>
							{% else %}
								<div class="text9 text-grey">There is no address assigned</div>
							{% endif %}
					</div>
						<button class="white-border-button" data-toggle-tab-target="user-payout-form" data-toggle-tab-group="user-payout">Edit info</button>	
				</div>
			
				<div data-toggle-tab="user-payout-form" data-toggle-tab-group="user-payout" style="display:none">
					{% include 'account/payout_info.html' %}
				</div>
			</div>
			{% endif %}
			<div id="user-donation-settings" class="account-settings-view">
				<div class="title5 account-settings-title text-bottom-line">Supporter settings</div>
				<div class="account-settings-info">
					<div class="text5">Current Monthly Pledge</div>
					{% if not customer_detail.subscription.plan or cancelled %}
					<div class="text9 accent-color">None{% if cancelled %} (cancelled) {% endif %}</div>
					{% else %}
					<div class="text9 accent-color">${{monthly_pledge_in_dollars}}/{{customer_detail.subscription.plan.interval}}</div>
					{% endif %}
					
					{% if not customer_detail.subscription.plan and not cancelled %}
						<a class="white-border-button" href="{% url 'become_supporter' %}">Become a Supporting Member</a>		
					{% elif customer_detail.subscription.plan and not period_end.due %}
						<div class="flex-row supporter-options">	
							<button class="white-border-button" onclick="$('#cancel-subscription').modal('toggle')">Cancel</button>		
							<button class="white-border-button">Update Pledge</button>	
						</div>	
					{% else %}
						<button class="white-border-button">Make a Recurring Monthly Pledge</button>	
					{% endif %}
				</div>
			
				<div class="account-settings-info ">
					{% if customer_detail.subscription.plan or user_archive_access_until %}
					<button class="white-border-button" id="one-time-donation-btn">Make a One Time Donation</button>		
					{% endif %}
				</div>
				<div class="account-settings-info">
					<div class="text5">Last donation</div>
					<div class="text9 text-grey">
						{% with customer_charges|first as first_charge%}
						{% if not customer_charges %}
						You haven't made an invoice yet
						{% else %}
						{{ first_charge.created|date:"d/m/Y"  }} ${{ first_charge.amount }}
						{% endif %}
						{% endwith %}
					</div>	
				</div>
				<div class="account-settings-info">
						<div class="text5">Total donations this year</div>
						<div class="text9 accent-color">${{charges_value}}</div>
				</div>
				<br>
				<br>
				<a href="{% url 'user_tax_letter' %}" class="white-border-button">Download tax document</a>
				<div class="account-settings-info ">
						<div class="text5">Expiration of archive access</div>
						{% if customer_detail.subscription.plan and not cancelled %}
						<div class="text9 text-grey">There is no expiration date until the monthly pledge is cancelled</div>
						{% elif user_archive_access_until %}
						<div class="text9 text-grey"> {{ user_archive_access_until|date:"d/m/Y" }} Because of a one time donation.</div>
						{% elif not customer_detail.subscription.plan and not period_end.due  %}
						<div class="text9 text-grey">{{ period_end.date }}</div>			
						{% else %}
						<div class="text9 text-grey">There is no access to the archive</div>
						{% endif %}
				</div>
			</div>
			
			<div id="user-billing" class="account-settings-view">
				<div class="title5 account-settings-title text-bottom-lineFin">Billing</div>
					<div class="account-settings-info">
						<div class="text5">Credit card</div>
						{% if not customer_detail.active_card %}
							<div class="text9 text-grey">There is no credit card assigned</div>
						{% else %}
							<div class="text9 text-grey">xxxx-xxxx-xxxx-{{customer_detail.active_card.last4}}</div>
							<div class="text9 text-grey">exp: {{customer_detail.active_card.exp_month}}/{{customer_detail.active_card.exp_year}}</div>
						{% endif %}
					</div>
					<div class="account-settings-info">
						<div class="text5">Billing address</div>
						{% if user.address_1 or user.address_2 or user.city %}
							<div class="text9 text-grey">{{ user.address_1 }}</div>
							<div class="text9 text-grey">{{ user.address_2 }}</div>
							<div class="text9 text-grey">{{user.city }}</div>
						{% else %}
							<div class="text9 text-grey">There is no address assigned</div>
						{% endif %}
					
					<button class="white-border-button">Update</button>	
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="cancel-subscription" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content custom-modal">
				<a href="#" class="close-button"></a>
				<div class="modal-body">
					{% if user.has_active_subscription %}
						<section class="account-settings-view">
							<div class="title5 account-settings-title text-bottom-line" style="text-align: center;">Cancelling pledge</div>
							<div class="account-settings-info cancel-info">
									<div class="text9">
										Your actual monthly pledge is ${{monthly_pledge_in_dollars}} giving you access to the archive until
										{{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}.<br>
										Canceling it will make the access to the archive videos unavailable until the renovation of the pledge or the
										making of a one time donation.
									</div>
									<div class="custom-settings-form">
										<form action="{% url 'cancel_subscription' %}" method="post" id="cancel-form" >
											{% csrf_token %}
											<button class="white-border-button" style="margin: 0 auto ; width: 100%;" >Cancel monthly pledge</button>
										</form>
									</div> 
							</div>
						</section>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="one-time-donation" aria-hidden="true">
		<div class="modal-dialog donate-dialog">
			<div class="modal-content custom-modal">
				<a href="#" class="close-button"></a>
				<div class="modal-body">
					<div id="donate-setting-steps" class="donate-setting-container" data-subpage-name="make-donation" data-subpage-url="{% url 'donate' %}">	
					</div>
					<div id="donate-setting-steps-complete" class="donate-setting-container" data-subpage-name="make-donation-complete" data-subpage-url="{% url 'donate_complete' %}">	
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


{% endblock%}

{% block footer %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/tabs.js' %}"></script>
<script src="{% static 'js/subpages.js' %}"></script>
<script>
    var subpages = window.subpages;
    subpages.register();
	$('#one-time-donation-btn').on('click', function () {
		$('#donate-setting-steps-complete').html("")
		$('#one-time-donation').modal('show');
		var donationSubpage = window.subpages.get("make-donation");
		donationSubpage.load();
	})
	
</script>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script>
  
  $(document).ready(function () {


	$('.close-button').bind("click", ToggleDisplay);

	function ToggleDisplay() {
		var $currentModal = $(this).closest('.modal');
		$currentModal.modal('hide');
	}

    var $streamingDialog = $('#cancel-subscription');
    var $streamingCloseButton = $($streamingDialog.find('.close-button')[0]);
    $streamingCloseButton.click(function () {
      $streamingDialog.modal('hide');
    });

    $('#btn-donate').click(function () {
        window.location = "{{ donate_url }}";
      });

  });

</script>
{% endblock %}