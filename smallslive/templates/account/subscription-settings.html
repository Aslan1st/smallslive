{% extends "smalls_base.html" %}
{% load djstripe_tags %}
{% load static from staticfiles %}
{% load socialaccount %}

{% block extra_head %}
    {% providers_media_js %}
{% endblock %}

{% block title %}Subscription settings{% endblock %}

{% block content %}
    <div class="content-wrapper">

        <section class="subscription-settings__header">
            <h1>Subscription settings</h1>
        </section>

        <section class="subscription-settings signup-plans">
            <div class="container">
                <div class="col-xs-12 col-sm-4 signup-plan  {% if user.get_subscription_plan.type == "free" %}plan-active{% endif %}">
                    <div class="signup-plan__content">
                        <p class="signup-plan__name">Free Plan</p>
                        <div class="signup-plan__price__container" id="signup-plan-price-slave">
                            <div class="signup-plan__price__free">
                                Free
                            </div>
                        </div>
                        <div class="signup-plan__arrow-separator"></div>
                        <ul class="signup-plan__features">
                            <li class="signup-plan__features__single">All of our shows are broadcast live each evening from Smalls Jazz Club.</li>
                            <li class="signup-plan__features__single">Most live shows will be available in our Audio/Video Archive within a week.</li>
                        </ul>
                        {% if user.get_subscription_plan.type == "free" %}
                          <p class="signup-plan__active__expiry">Free plan never expires</p>
                        {% else %}
                          <p class="signup-plan__button disabled" href="#">Can’t downgrade*</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-xs-12 col-sm-4 signup-plan {% if user.get_subscription_plan.type == "basic" %}plan-active{% endif %}">
                    <div class="signup-plan__content">
                        <p class="signup-plan__name">Audio/Video Archive & Live Video Stream Access</p>
                        <div class="signup-plan__price__container" id="signup-plan-price-master">
                            <div class="signup-plan__price__primary">
                                <span class="signup-plan__price__primary__currency">$</span>
                                <span class="signup-plan__price__primary__amount">10</span>
                                <span class="signup-plan__price__primary__period">/ MO</span>
                            </div>
                            <div class="signup-plan__price__promo">
                                Or get 2 months for free
                            </div>
                            <div class="signup-plan__price__secondary">
                                <span class="signup-plan__price__secondary__currency">$</span>
                                <span class="signup-plan__price__secondary__amount">100</span>
                                <span class="signup-plan__price__secondary__period">/ year</span>
                            </div>
                        </div>
                        <div class="signup-plan__arrow-separator"></div>
                        <ul class="signup-plan__features">
                            <li class="signup-plan__features__single">Unlimited access to our <b>Audio/Video Archive</b> and <b>Live Video Stream</b>.</li>
                            <li class="signup-plan__features__single">New content is added weekly.</li>
                            <li class="signup-plan__features__single">Revenue from this subscription is pooled and directly disturbed to the artists via the SmallsLIVE Artist Revenue Share Project.</li>
                        </ul>
                        {% with active_plan=user.get_subscription_plan.type %}
                          {% if active_plan == "basic" %}
                            {% if user.customer.current_subscription.cancel_at_period_end %}
                                <p class="signup-plan__active__expiry">Plan expires on {{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</p>
                            {% else %}
                                <p class="signup-plan__active__expiry">Plan will renew on {{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</p>
                            {% endif %}
                          {% elif active_plan == "premium" %}
                            <p class="signup-plan__button disabled" href="#">Can’t downgrade*</p>
                          {% elif active_plan == "free" %}
                            <a class="signup-plan__button" href="{% url "upgrade_plan" plan_name="basic" %}">Upgrade (+ $9/mo)</a>
                          {% endif %}
                        {% endwith %}
                    </div>
                </div>
                <div class="col-xs-12 col-sm-4 signup-plan  {% if user.get_subscription_plan.type == "premium" %}plan-active{% endif %}">
                    <div class="signup-plan__content">
                        <p class="signup-plan__name">Benefactor Member</p>
                        <div class="signup-plan__price__container">
                            <div class="signup-plan__price__primary">
                                <span class="signup-plan__price__primary__currency">$</span>
                                <span class="signup-plan__price__primary__amount">100</span>
                                <span class="signup-plan__price__primary__period">/ MO</span>
                            </div>
                            <div class="signup-plan__price__promo">
                                Or get 2 months for free
                            </div>
                            <div class="signup-plan__price__secondary">
                                <span class="signup-plan__price__secondary__currency">$</span>
                                <span class="signup-plan__price__secondary__amount">1000</span>
                                <span class="signup-plan__price__secondary__period">/ year</span>
                            </div>
                        </div>
                        <div class="signup-plan__arrow-separator"></div>
                        <ul class="signup-plan__features">
                            <li class="signup-plan__features__single"><b>Unlimited access</b> to our Audio/Video Archive and Live Video Stream.</li>
                            <li class="signup-plan__features__single">Benefactor Members are <b>members who wish to support</b> SmallsLIVE and the Artists that perform there in a greater way.</li>
                            <li class="signup-plan__features__single">Revenue from this subscription is <b>pooled and directly disturbed to the artists</b> via the SmallsLIVE Artist Revenue Share Project.</li>
                            <li class="signup-plan__features__single">Your subscription <b>directly supports the artists and the venue</b>.</li>
                            <li class="signup-plan__features__single">Benefactor Members are offered merchandise, club passes and exclusive content. <a href="#">Click here</a> for more information.</li>
                        </ul>
                        {% with active_plan=user.get_subscription_plan.type %}
                          {% if active_plan == "premium" %}
                            {% if user.customer.current_subscription.cancel_at_period_end %}
                                <p class="signup-plan__active__expiry">Plan expires on {{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</p>
                            {% else %}
                                <p class="signup-plan__active__expiry">Plan will renew on {{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</p>
                            {% endif %}
                          {% elif active_plan == "basic" %}
                            <a class="signup-plan__button" href="{% url "upgrade_plan" plan_name="premium" %}">Upgrade (+ $6/mo)</a>
                          {% elif active_plan == "free" %}
                            <a class="signup-plan__button" href="{% url "upgrade_plan" plan_name="premium" %}">Upgrade (+ $15/mo)</a>
                          {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% if user.get_subscription_plan.type != "free" %}
                  <p class="signup-plans__downgrade-notice">* your account gets downgraded to a Free Plan automatically upon not extending your subscription in time.</p>
                {% endif %}
            </div>
        </section>

      {% if user.has_active_subscription %}
        <section class="subscription-settings subscription-settings__auto-renewal container">
          <h3 class="subscription-settings__heading">Auto renewal</h3>
          <div class="row">
            {% if user.customer.current_subscription.cancel_at_period_end %}
              <div class="col-xs-12 col-sm-9 subscription-settings__auto-renewal__text">
                Auto renewal is disabled on your Subscription. When the current subscription ends on
                <b>{{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</b>, you'll be downgraded to the
                <b>Free</b> plan and will have to subscribe once again manually.
              </div>
            {% else %}
              <div class="col-xs-12 col-sm-9 subscription-settings__auto-renewal__text">
                Auto renewal is activated on your Subscription, so your credit card will be charged again for the next
                {{ user.get_subscription_plan.interval }} on <b>{{ user.get_current_subscription.current_period_end|date:"n/j/Y" }} for
                ${{ user.get_subscription_plan.price|djdiv:100|floatformat:"2" }}</b> to renew your selected plan.
              </div>
              <div class="col-xs-12 col-sm-3">
                <button class="setting-toggle-button">Disable Auto renewal</button>
              </div>
            {% endif %}
          </div>
        </section>
      {% endif %}

      <section class="subscription-settings signup__payment">
        <h3 class="signup__payment__heading">Billing information:</h3>
        {% if user.customer.can_charge %}
          <div class="row">
              <p class="signup__payment__existing-card">You have a saved {{ user.customer.card_kind }} credit card ending
                with {{ user.customer.card_last_4 }}.
                <a href="" id="payment-form-toggle">Click here</a> to change your active credit card.</p>
          </div>
        {% endif %}
        <div class="signup__payment__information row" {% if user.customer.card_last_4 %}style="display:none"{% endif %}>
          <div class="col-xs-12 col-sm-6">
            <p class="signup__payment__text">We accept the following credit cards:</p>
                    <div class="signup__payment__card-icons">
                        <img src="{% static 'image/payment/visa.png' %}" alt="Visa">
                        <img src="{% static 'image/payment/mastercard.png' %}" alt="MasterCard">
                        <img src="{% static 'image/payment/amex.png' %}" alt="American Express">
                        <img src="{% static 'image/payment/diners.png' %}" alt="Diners">
                    </div>
            <form class="payment-form" id="payment-form" method="post" action="{% url "update_card" %}">
              {% csrf_token %}
              <div class="signup__payment__card__info">
                <label for="card-number">Credit card number</label>
                <input type="text" class="form-control" name="card-number" id="card-number"
                       placeholder="XXXX XXXX XXXX XXXX"
                       size="20" pattern="[\d ]*" autocomplete="off" data-stripe="number">
                <label for="expiry" id="expiry-label">Valid thru:</label>
                <label for="cvc" id="cvc-label">CVC</label>
                <input type="text" class="form-control quarter-group" name="expiry-month" id="expiry-month"
                       placeholder="MM"
                       size="2" pattern="\d*" autocomplete="off" data-stripe="exp-month">
                <input type="text" class="form-control quarter-group" name="expiry-year" id="expiry-year"
                       placeholder="YY"
                       size="2" pattern="\d*" autocomplete="off" data-stripe="exp-year">
                <input type="text" class="form-control half" name="cvc" id="cvc" placeholder="xxx" size="4"
                       pattern="\d*"
                       autocomplete="off" data-stripe="cvc">
                <label for="name">Name on card</label>
                <input type="text" class="form-control" name="name" placeholder="Name on card">
                <div class="payment-errors"></div>
                <input type="submit" class="submit-button" value="Save Changes">
                <button class="submit-button light-button" id="card-update-cancel">Cancel</button>
              </div>
            </form>

          </div>
          <div class="col-xs-12 col-sm-6 signup__payment__card__image">
            <div class="card-wrapper"></div>
          </div>
        </div>

      </section>
    {% if user.has_active_subscription %}
      <div id="payment-history">
        {% include "account/blocks/payment_history.html" %}
      </div>
    {% endif %}

    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'js/card.js' %}"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script>
        var card = new Card({
            // a selector or DOM element for the form where users will
            // be entering their information
            form: '.payment-form', // *required*
            // a selector or DOM element for the container
            // where you want the card to appear
            container: '.card-wrapper', // *required*

            formSelectors: {
                numberInput: 'input[name="card-number"]', // optional — default input[name="number"]
                expiryInput: 'input[name="expiry-month"], input[name="expiry-year"]', // optional — default input[name="expiry"]
                cvcInput: 'input[name="cvc"]', // optional — default input[name="cvc"]
                nameInput: 'input[name="name"]' // optional - defaults input[name="name"]
            },

            width: 350, // optional — default 350px
            formatting: true, // optional - default true


            // Default values for rendered fields - optional
            values: {
                number: 'XXXX XXXX XXXX XXXX',
                name: 'Name',
                expiry: '••/••',
                cvc: '•••'
            },

            // if true, will log helpful messages for setting up Card
            debug: false // optional - default false
        });
    </script>
    <script>
      $(function() {
          $.post("{% url 'sync_payment_history' %}", function(data) {
              $('#payment-history').html(data);
              $('.in-progress-gif').hide();
          });
      });
    $(document).ready(function() {
      $("#payment-form-toggle, #card-update-cancel").on('click', function(e) {
        e.preventDefault();
        $(".signup__payment__information").slideToggle("fast");
        $(".signup__payment__existing-card").slideToggle("fast");
        return false;
      })
    })
  </script>
      <script type="text/javascript">
      // This identifies your website in the createToken call below
      Stripe.setPublishableKey('{{ STRIPE_PUBLIC_KEY }}');
      jQuery(function ($) {
        $('#payment-form').submit(function (event) {
          var $form = $(this);

          // Disable the submit button to prevent repeated clicks
          $form.find('.submit-button').prop('disabled', true).addClass('disabled');

          Stripe.card.createToken($form, stripeResponseHandler);

          // Prevent the form from submitting with the default action
          return false;
        });

        var stripeResponseHandler = function (status, response) {
          var $form = $('#payment-form');

          if (response.error) {
            // Show the errors on the form
            $form.find('.payment-errors').text(response.error.message);
            $form.find('.submit-button').prop('disabled', false).removeClass('disabled');
          } else {
            // token contains id, last4, and card type
            var token = response.id;
            // Insert the token into the form so it gets submitted to the server
            $form.append($('<input type="hidden" name="stripe_token" />').val(token));
            // and submit
            $form.get(0).submit();
          }
        };
      });
    </script>
{% endblock %}
