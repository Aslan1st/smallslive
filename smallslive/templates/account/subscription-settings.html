{% extends "smalls_base.html" %}
{% load djstripe_tags %}
{% load static from staticfiles %}
{% load socialaccount %}

{% block extra_head %}
    {% providers_media_js %}
{% endblock %}

{% block content %}
    <div class="content-wrapper">

        <section class="subscription-settings__header">
            <h1>Subscription settings</h1>
        </section>

        <section class="subscription-settings signup-plans">
            <div class="container">
                <div class="col-xs-12 col-sm-4 signup-plan  {% if user.get_subscription_plan.type == "free" %}plan-active{% endif %}">
                    <div class="signup-plan__content">
                        <p class="signup-plan__name">Free Plan</p>
                        <div class="signup-plan__price__container" id="signup-plan-price-slave">
                            <div class="signup-plan__price__free">
                                Free
                            </div>
                        </div>
                        <div class="signup-plan__arrow-separator"></div>
                        <ul class="signup-plan__features">
                            <li class="signup-plan__features__single">watch <b>all our shows live</b> via our live stream.</li>
                        </ul>
                        {% if user.get_subscription_plan.type == "free" %}
                          <p class="signup-plan__active__expiry">Free plan never expires</p>
                        {% else %}
                          <p class="signup-plan__button disabled" href="#">Can’t downgrade*</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-xs-12 col-sm-4 signup-plan {% if user.get_subscription_plan.type == "basic" %}plan-active{% endif %}">
                    <div class="signup-plan__content">
                        <p class="signup-plan__name">Basic Membership</p>
                        <div class="signup-plan__price__container" id="signup-plan-price-master">
                            <div class="signup-plan__price__primary">
                                <span class="signup-plan__price__primary__currency">$</span>
                                <span class="signup-plan__price__primary__amount">9</span>
                                <span class="signup-plan__price__primary__period">/ MO</span>
                            </div>
                            <div class="signup-plan__price__promo">
                                Or get 2 months for free
                            </div>
                            <div class="signup-plan__price__secondary">
                                <span class="signup-plan__price__secondary__currency">$</span>
                                <span class="signup-plan__price__secondary__amount">90</span>
                                <span class="signup-plan__price__secondary__period">/ year</span>
                            </div>
                        </div>
                        <div class="signup-plan__arrow-separator"></div>
                        <ul class="signup-plan__features">
                            <li class="signup-plan__features__single">watch <b>all our shows live</b> via our live stream</li>
                            <li class="signup-plan__features__single">access to <b>all audio recordings</b></li>
                            <li class="signup-plan__features__single">new shows <b>added weekly</b> </li>
                            <li class="signup-plan__features__single">revenue from subscriptions pooled and <b>directly distributed to artists</b> based on how much they get listened to</li>
                        </ul>
                        {% with active_plan=user.get_subscription_plan.type %}
                          {% if active_plan == "basic" %}
                            <p class="signup-plan__active__expiry">Plan expires on {{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</p>
                          {% elif active_plan == "premium" %}
                            <p class="signup-plan__button disabled" href="#">Can’t downgrade*</p>
                          {% elif active_plan == "free" %}
                            <a class="signup-plan__button" href="#">Upgrade (+ $9/mo)</a>
                          {% endif %}
                        {% endwith %}
                    </div>
                </div>
                <div class="col-xs-12 col-sm-4 signup-plan  {% if user.get_subscription_plan.type == "premium" %}plan-active{% endif %}">
                    <div class="signup-plan__content">
                        <p class="signup-plan__name">Premium Membership</p>
                        <div class="signup-plan__price__container">
                            <div class="signup-plan__price__primary">
                                <span class="signup-plan__price__primary__currency">$</span>
                                <span class="signup-plan__price__primary__amount">15</span>
                                <span class="signup-plan__price__primary__period">/ MO</span>
                            </div>
                            <div class="signup-plan__price__promo">
                                Or get 2 months for free
                            </div>
                            <div class="signup-plan__price__secondary">
                                <span class="signup-plan__price__secondary__currency">$</span>
                                <span class="signup-plan__price__secondary__amount">150</span>
                                <span class="signup-plan__price__secondary__period">/ year</span>
                            </div>
                        </div>
                        <div class="signup-plan__arrow-separator"></div>
                        <ul class="signup-plan__features">
                            <li class="signup-plan__features__single">watch <b>all our shows live</b> via our live stream</li>
                            <li class="signup-plan__features__single">access to <b>all audio recordings</b></li>
                            <li class="signup-plan__features__single">access to <b>all video recordings</b></li>
                            <li class="signup-plan__features__single">new shows <b>added weekly</b> </li>
                            <li class="signup-plan__features__single">revenue from subscriptions pooled and <b>directly distributed to artists</b> based on how much they get listened to</li>
                        </ul>
                        {% with active_plan=user.get_subscription_plan.type %}
                          {% if active_plan == "premium" %}
                            <p class="signup-plan__active__expiry">Plan expires on {{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</p>
                          {% elif active_plan == "basic" %}
                            <a class="signup-plan__button" href="#">Upgrade (+ $6/mo)</a>
                          {% elif active_plan == "free" %}
                            <a class="signup-plan__button" href="#">Upgrade (+ $15/mo)</a>
                          {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% if user.get_subscription_plan.type != "free" %}
                  <p class="signup-plans__downgrade-notice">* your account gets downgraded to a Free Plan automatically upon not extending your subscription in time.</p>
                {% endif %}
            </div>
        </section>

        <section class="subscription-settings subscription-settings__auto-renewal container">
            <h3 class="subscription-settings__heading">Auto renewal</h3>
            <div class="row">
              {% if user.has_active_subscription %}
                <div class="col-xs-12 col-sm-9 subscription-settings__auto-renewal__text">
                    Auto renewal is activated on your Subscription, so your credit card will be charged again for the next month on <b>{{ user.get_current_subscription.current_period_end|date:"n/j/Y" }} for ${{ user.get_subscription_plan.price|djdiv:100|floatformat:"2" }}</b> to renew your selected plan.
                </div>
                <div class="col-xs-12 col-sm-3">
                    <button class="setting-toggle-button">Disable Auto renewal</button>
                </div>
              {% else %}
                <div class="col-xs-12 col-sm-9 subscription-settings__auto-renewal__text">
                    Auto renewal is disabled on your Subscription. When the current subscription ends on <b>{{ user.get_current_subscription.current_period_end|date:"n/j/Y" }}</b>, you'll be downgraded to the
                <b>Free</b> plan and will have to subscribe once again manually.
                </div>
              {% endif %}
            </div>
        </section>

        <section class="subscription-settings signup__payment">
            <h3 class="signup__payment__heading">Billing information:</h3>
          {% if user.has_active_subscription %}
            <p class="signup__payment__existing-card">You have a saved {{ user.customer.card_kind }} credit card ending with {{ user.customer.card_last_4 }}.
              <a href="" id="payment-form-toggle">Click here</a> to change your active credit card.</p>
          {% endif %}
          <div class="signup__payment__information row" {% if user.has_active_subscription %}style="display:none"{% endif %}>
            <div class="col-xs-12 col-sm-6">
              <form class="payment-form" >
                <div class="signup__payment__card__info">
                  <label for="card-number">Credit card number</label>
                  <input type="text" class="form-control" name="card-number" id="card-number"
                         placeholder="XXXX XXXX XXXX XXXX">
                  <label for="expiry" id="expiry-label">Valid thru:</label>
                  <label for="cvc" id="cvc-label">Secret number</label>
                  <input type="text" class="form-control quarter-group" name="expiry-month" id="expiry-month"
                         placeholder="MM">
                  <input type="text" class="form-control quarter-group" name="expiry-year" id="expiry-year" placeholder="YY">
                  <input type="text" class="form-control half" name="cvc" id="cvc" placeholder="xxx">
                  <label for="name">Name on card</label>
                  <input type="text" class="form-control" name="name" placeholder="Name">
                  <input type="submit" class="submit-button disabled" disabled value="Save Changes">
                </div>
              </form>

            </div>
            <div class="col-xs-12 col-sm-6 signup__payment__card__image">
              <div class="card-wrapper"></div>
            </div>
          </div>
        </section>
    {% if user.has_active_subscription %}
      <div id="payment-history">
        {% include "account/blocks/payment_history.html" %}
      </div>
    {% endif %}

    </div>
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'js/card.js' %}"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script>
        var card = new Card({
            // a selector or DOM element for the form where users will
            // be entering their information
            form: '.payment-form', // *required*
            // a selector or DOM element for the container
            // where you want the card to appear
            container: '.card-wrapper', // *required*

            formSelectors: {
                numberInput: 'input[name="card-number"]', // optional — default input[name="number"]
                expiryInput: 'input[name="expiry-month"], input[name="expiry-year"]', // optional — default input[name="expiry"]
                cvcInput: 'input[name="cvc"]', // optional — default input[name="cvc"]
                nameInput: 'input[name="name"]' // optional - defaults input[name="name"]
            },

            width: 350, // optional — default 350px
            formatting: true, // optional - default true


            // Default values for rendered fields - optional
            values: {
                number: 'XXXX XXXX XXXX XXXX',
                name: 'Name',
                expiry: '••/••',
                cvc: '•••'
            },

            // if true, will log helpful messages for setting up Card
            debug: false // optional - default false
        });
    </script>
    <script>
      $(function() {
          $.post("{% url 'sync_payment_history' %}", function(data) {
              $('#payment-history').html(data);
              $('.in-progress-gif').hide();
          });
      });
    $(document).ready(function() {
      $("#payment-form-toggle").on('click', function(e) {
        e.preventDefault();
        $(".signup__payment__information").toggle();
        $(".signup__payment__existing-card").toggle();
        return false;
      })
    })
  </script>
{% endblock %}
